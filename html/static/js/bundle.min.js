class events{constructor(logger){this.events={};this.logger=logger||console}on(event_name,callback){try{if(typeof event_name!=="string"){throw new Error("Event name must be a string")}if(typeof callback!=="function"){throw new Error("Callback must be a function")}if(!this.events[event_name]){this.events[event_name]=[]}this.events[event_name].push(callback)}catch(error){this.logger.error(`on(${event_name}): ${error.message}`)}}emit(event_name,data=null){try{if(data==null){data={}}if(this.hasOwnProperty("parent")){data.parent=this.parent}data.instance=this;data.event=event_name;if(this.events[event_name]){this.events[event_name].forEach(callback=>{try{callback(data)}catch(cbError){this.logger.error(`emit(${event_name}) callback error: ${cbError.message}`)}})}}catch(error){this.logger.error(`emit(${event_name}): ${error.message}`)}}}class point{constructor(x,y){this.x=x;this.y=y}}class rect{constructor(x,y,width,height,x_mode="left",y_mode="top"){this._x=x!==null?parseInt(x):null;this._y=y!==null?parseInt(y):null;this._width=width!==null?parseInt(width):null;this._height=height!==null?parseInt(height):null;this._y_mode=y_mode!==null?y_mode:"top";this._x_mode=x_mode!==null?x_mode:"left"}get x(){return this._x}set x(value){this._x=parseInt(value)}get y(){return this._y}set y(value){this._y=parseInt(value)}get width(){return this._width}set width(value){if(value>=0){this._width=parseInt(value);switch(this._x_mode){case"center":parseInt(this._x-=value/2);break}}}get height(){return this._height}set height(value){if(value>=0){this._height=parseInt(value);switch(this._y_mode){case"center":parseInt(this._y-=value/2);break}}}set center_x(value){this._x=parseInt(value-this._width/2)}set center_y(value){this._y=parseInt(value-this._height/2)}get center_x(){if(this._width==null)return this.x;return parseInt(this._x+this._width/2)}get center_y(){if(this._height==null)return this.y;return parseInt(this._y+this._height/2)}get bottom(){if(this._height==null)return this.y;return this.y+this._height}get right(){if(this._width==null)return this.x;return this.x+this._width}get left(){return this.x}get top(){return this.y}round(){this.x=Math.round(this.x);this.y=Math.round(this.y);if(this._width!=null)this.width=Math.round(this._width);if(this._height!=null)this.height=Math.round(this._height)}clone(){return new rect(this._x,this._y,this._width,this._height,this._x_mode,this._y_mode)}add(rect2){this._x+=rect2.x;this._y+=rect2.y}get_scale(dest){let scale_x=dest.width/this._width;let scale_y=dest.height/this._height;return new point(scale_x,scale_y)}set_scale(dest){if(this._x!=null)this._x=parseInt(this._x*dest.x);if(this._y!=null)this._y=parseInt(this._y*dest.y);if(this._width!=null)this._width=parseInt(this._width*dest.x);if(this._height!=null)this._height=parseInt(this._height*dest.y)}}class grid{constructor(outer,inner,size=9){this.outer=outer;this.inner=inner;if(size==9){this.quadrants=this.calculate_quadrants_9()}if(size==3){this.quadrants=this.calculate_quadrants_3()}}calculate_quadrants_3(){const quadrants=[];let top_right_width=this.outer.x+this.outer.width-(this.inner.x+this.inner.width);quadrants.push(new rect(this.outer.x,this.outer.y,this.inner.x-this.outer.x,this.outer.height));quadrants.push(new rect(this.inner.x,this.outer.y,this.inner.width,this.outer.height));quadrants.push(new rect(this.inner.x+this.inner.width,this.outer.y,top_right_width,this.outer.height));return quadrants}calculate_quadrants_9(){const quadrants=[];let top_left_width=this.inner.x-this.outer.x;let top_left_height=this.inner.y-this.outer.y;let top_right_width=this.outer.x+this.outer.width-(this.inner.x+this.inner.width);let top_right_height=this.inner.y-this.outer.y;let bottom_left_width=this.inner.x-this.outer.x;let bottom_left_height=this.outer.y+this.outer.height-(this.inner.y+this.inner.height);let bottom_right_width=this.outer.x+this.outer.width-(this.inner.x+this.inner.width);let bottom_right_height=this.outer.y+this.outer.height-(this.inner.y+this.inner.height);quadrants.push(new rect(this.outer.x,this.outer.y,top_left_width,top_left_height));quadrants.push(new rect(this.inner.x,this.outer.y,this.inner.width,top_left_height));quadrants.push(new rect(this.inner.x+this.inner.width,this.outer.y,top_right_width,top_right_height));quadrants.push(new rect(this.outer.x,this.inner.y,top_left_width,this.inner.height));quadrants.push(new rect(this.inner.x,this.inner.y,this.inner.width,this.inner.height));quadrants.push(new rect(this.inner.x+this.inner.width,this.inner.y,top_right_width,this.inner.height));quadrants.push(new rect(this.outer.x,this.inner.y+this.inner.height,bottom_left_width,bottom_left_height));quadrants.push(new rect(this.inner.x,this.inner.y+this.inner.height,this.inner.width,bottom_left_height));quadrants.push(new rect(this.inner.x+this.inner.width,this.inner.y+this.inner.height,bottom_right_width,bottom_right_height));return quadrants}}class audio_manager{constructor(logger){this.audioBuffers=new Map;this.audioSources=new Map;this.playSounds=true;this.defaultVolume=.4;this.logger=logger||console;this.audioContext=new(window.AudioContext||window.webkitAudioContext);this.masterGain=this.audioContext.createGain();this.masterGain.gain.value=this.defaultVolume;this.masterGain.connect(this.audioContext.destination)}sanitize_path(path){if(typeof path!=="string"){throw new Error("Invalid audio path type")}return path.replace(/[<>"'`;]/g,"")}async add(key,audioPath=null){try{if(audioPath===null)audioPath=key;audioPath=this.sanitize_path(audioPath);const response=await fetch(audioPath);const arrayBuffer=await response.arrayBuffer();const audioBuffer=await this.audioContext.decodeAudioData(arrayBuffer);this.audioBuffers.set(key,audioBuffer);return audioBuffer}catch(error){console.error(`add(${key}): ${error.message}`);throw error}}get(key){try{if(this.audioBuffers.has(key)){return this.audioBuffers.get(key)}else{console.warn(`get(${key}): Sound not found`);return false}}catch(error){console.error(`get(${key}): ${error.message}`);throw error}}is_playing(key){try{return this.audioSources.has(key)&&this.audioSources.get(key)!==null}catch(error){console.error(`is_playing(${key}): ${error.message}`);return false}}async play(key,startTime=0,loop=false){try{if(this.audioContext.state==="suspended"){await this.audioContext.resume()}if(!this.playSounds||!this.audioBuffers.has(key)){console.warn(`play(${key}): Sound not available or playback disabled`);return}this.stop(key);const audioBuffer=this.audioBuffers.get(key);const source=this.audioContext.createBufferSource();source.buffer=audioBuffer;source.loop=loop;const gainNode=this.audioContext.createGain();gainNode.gain.value=1;source.connect(gainNode);gainNode.connect(this.masterGain);this.audioSources.set(key,{source:source,gainNode:gainNode,startedAt:this.audioContext.currentTime-startTime});source.start(0,startTime);if(!loop){source.onended=()=>{if(this.audioSources.get(key)?.source===source){this.audioSources.delete(key)}}}}catch(error){console.error(`play(${key}): ${error.message}`,error)}}stop(key){try{const sourceData=this.audioSources.get(key);if(sourceData){try{sourceData.source.stop()}catch(e){}this.audioSources.delete(key)}}catch(error){console.error(`stop(${key}): ${error.message}`)}}pause(key){try{const sourceData=this.audioSources.get(key);if(sourceData){const elapsed=this.audioContext.currentTime-sourceData.startedAt;const wasLooping=sourceData.source.loop;this.stop(key);this.audioSources.set(key+"_paused",{elapsed:elapsed,loop:wasLooping})}}catch(error){console.error(`pause(${key}): ${error.message}`)}}async resume(key){try{const pausedData=this.audioSources.get(key+"_paused");if(pausedData){const startTime=pausedData.elapsed||0;const loop=pausedData.loop||false;this.audioSources.delete(key+"_paused");await this.play(key,startTime,loop)}}catch(error){console.error(`resume(${key}): ${error.message}`)}}sound_off(){try{this.playSounds=false;this.masterGain.gain.value=0}catch(error){console.error(`sound_off: ${error.message}`)}}sound_on(){try{this.playSounds=true;this.masterGain.gain.value=this.defaultVolume}catch(error){console.error(`sound_on: ${error.message}`)}}set_volume(key,volume){if(volume==null||isNaN(volume)){console.error("Invalid volume value");return}try{const sourceData=this.audioSources.get(key);if(sourceData&&sourceData.gainNode){sourceData.gainNode.gain.value=volume}}catch(error){console.error(`set_volume(${key}): ${error.message}`)}}set_master_volume(volume){if(volume==null||isNaN(volume)){console.error("Invalid volume value");return}try{this.defaultVolume=volume;this.masterGain.gain.value=volume}catch(error){console.error(`set_master_volume: ${error.message}`)}}}class sprites extends events{constructor(ctx){super();this.base_domain="https://aijobwars.com/";this.ctx=ctx;this.sprites={};this.images={};this.loaded=false}preload(){this.add("window","static/UI/UI1.png",67,67,565,332);this.add("window-title","static/UI/UI1.png",162-10,411-10,372+10*2,68+10*2);this.add("button-down-red","static/UI/UI1.png",683,77,206,68);this.add("button-up-red","static/UI/UI1.png",683,161,206,68);this.add("button-down-yellow","static/UI/UI1.png",928,77,206,68);this.add("button-up-yellow","static/UI/UI1.png",927,161,206,68);this.add("button-down-cyan","static/UI/UI1.png",683,281,206,68);this.add("button-up-cyan","static/UI/UI1.png",683,365,206,68);this.add("button-down-gray","static/UI/UI1.png",928,281,206,68);this.add("button-up-gray","static/UI/UI1.png",927,365,206,68);this.add("percentage-full","static/UI/UI1.png",182-12,707-12,30+12*2,45+12*2);this.add("percentage-empty","static/UI/UI1.png",929-12,707-12,30+12*2,45+12*2);this.add("window-thinn","static/UI/UI4.png",1721-10,154-10,348+10*2,466+10*2);this.add("window-close-up","static/UI/UI4.png",1806,678,42,42);this.add("window-close-down","static/UI/UI4.png",1857,677,42,42);this.add("window-right-corner","static/UI/UI4.png",1908,661,80,73);this.add("scroll-down","static/UI/UI4.png",1641,585,32,32);this.add("scroll-up","static/UI/UI4.png",1641,144,32,32);this.add("scroll-drag","static/UI/UI4.png",1641,194,30,54);this.add("scroll-bg","static/UI/UI4.png",1641,267,32,300);this.add("bar","static/UI/UI4.png",766,760,357,47);this.add("bar-red-fluid","static/UI/UI4.png",780,901,312,33);this.add("bar-green-fluid","static/UI/UI4.png",1097,901,312,32);this.add("bar-blue-fluid","static/UI/UI4.png",781,939,312,33);this.add("bar-orange-fluid","static/UI/UI4.png",1098,939,312,33);this.add("portal","static/UI/UI4.png",569,763,158,158);this.add("menu","static/UI/menu.webp");this.add("blue_font","static/fonts/obitron-blue.png");this.add("grey_font","static/fonts/obitron-grey.png");this.add("red_font","static/fonts/obitron-red.png");this.add("title","static/intro/AI-JOB-WARS-3-24-2024.png");this.add("static/debris/email.png","static/debris/email.png");this.add("static/debris/pdf.png","static/debris/pdf.png");this.add("static/debris/phone.png","static/debris/phone.png");this.add("static/debris/webex2.png","static/debris/webex2.png");this.add("static/blocks/block.png","static/blocks/block.png");this.add("static/explosion/exp_9_128x128_35frames_strip35.png","static/explosion/exp_9_128x128_35frames_strip35.png");this.add("static/ships/ship1.png","static/ships/ship1.png");this.add("static/ships/teams.png","static/ships/teams.png");this.add("static/projectiles/Arcane Bolt.png","static/projectiles/Arcane Bolt.png");this.add("static/projectiles/Firebomb.png","static/projectiles/Firebomb.png");this.add("static/ships/Water Bolt.png","static/ships/Water Bolt.png");this.add("static/ships/booster.png","static/ships/booster.png");this.add("static/projectiles/P2.png","static/projectiles/P2.png");this.add("static/scene/bg_stars.png","static/scene/bg_stars.png");this.on_load()}add(key,imagePath=null,x=0,y=0,width=null,height=null){if(this.sprites[key]){return this.sprites[key].image}if(imagePath==null)imagePath=key;if(!(imagePath in this.images)){this.images[imagePath]=new Promise((resolve,reject)=>{const img=new Image;img.onload=()=>{resolve(img)};img.onerror=error=>{reject(error)};img.src=imagePath})}return this.images[imagePath].then(image=>{this.sprites[key]={image:image,url:imagePath,position:new rect(x,y,width||image.width,height||image.height),x:x,y:y,width:width||image.width,height:height||image.height,collision_mask:null,mask_bounds:null}})}on_load(){Promise.all(Object.values(this.images)).then(()=>{this.loaded=true;this.emit("complete");console.log("Loaded Images")}).catch(error=>{console.error("Error preloading images:",error)})}get_or_create_collision_mask(key,position){const sprite=this.sprites[key];if(!sprite){console.log("Missing image: "+key);return null}if(sprite.collision_mask&&sprite.mask_bounds){return{collision_mask:sprite.collision_mask,mask_bounds:sprite.mask_bounds}}const pixelData=this.get_data(key,position);if(!pixelData)return null;sprite.collision_mask=new Array(position.width*position.height);for(let i=0;i<position.width*position.height;i++){const alpha=pixelData[i*4+3];sprite.collision_mask[i]=alpha>50}sprite.mask_bounds=this.get_bounds(key,position);console.log(`[Sprite] Collision mask generated for '${key}': ${position.width}x${position.height}`);return{collision_mask:sprite.collision_mask,mask_bounds:sprite.mask_bounds}}get_bounds(key,position){let data=this.get_data(key,position);let left=position.width;let top=position.height;let right=0;let bottom=0;let found=false;let index=0;for(let y=0;y<position.height;y++){for(let x=0;x<position.width;x++){const alpha=data[index];if(alpha>0){found=true;left=Math.min(left,x);top=Math.min(top,y);right=Math.max(right,x);bottom=Math.max(bottom,y)}index+=4}}if(found==false){left=0;right=position.width;top=0;bottom=position.height}return new rect(left,top,right-left,bottom-top,"left","top")}draw_colored_rectangle(position,color){this.ctx.fillStyle=color;this.ctx.fillRect(position.x,position.y,position.width,position.height)}get_data(key,position){let s=this.get(key);if(!s){console.log("Missing image");return}let canvas=document.createElement("canvas");let ctx=canvas.getContext("2d");canvas.width=position.width;canvas.height=position.height;ctx.drawImage(s.image,position.x,position.y,position.width,position.height,0,0,position.width,position.height);let imageData=ctx.getImageData(0,0,canvas.width,canvas.height);return imageData.data}draw_rect(position,color){this.ctx.fillStyle=color;this.ctx.fillRect(position.x,position.y,position.width,position.height)}render(key,src,dest,intensity=1,mode="fill"){const s=this.sprites[key];if(!s){console.log("Missing image: "+key);return}if(src==null)src=new rect(s.x,s.y,s.width,s.height);this.ctx._saveCount=(this.ctx._saveCount||0)+1;this.ctx.save();this.ctx.globalAlpha=intensity;let dx=dest.x;let dy=dest.y;let dWidth=dest.width||s.width;let dHeight=dest.height||s.height;const imgAspectRatio=s.width/s.height;const destAspectRatio=dest.width/dest.height;switch(mode){case"contain":if(imgAspectRatio>destAspectRatio){dHeight=dest.width/imgAspectRatio;dy+=(dest.height-dHeight)/2}else{dWidth=dest.height*imgAspectRatio;dx+=(dest.width-dWidth)/2}break;case"cover":if(imgAspectRatio>destAspectRatio){dWidth=dest.height*imgAspectRatio;dx-=(dWidth-dest.width)/2}else{dHeight=dest.width/imgAspectRatio;dy-=(dHeight-dest.height)/2}break;case"none":if(!dest.width||!dest.height){dWidth=s.width;dHeight=s.height}else{dx=dest.x+(dest.width-dWidth)/2;dy=dest.y+(dest.height-dHeight)/2}break;case"scale-down":const scaleDownWidth=imgAspectRatio>destAspectRatio?dest.width:dest.height*imgAspectRatio;const scaleDownHeight=imgAspectRatio>destAspectRatio?dest.width/imgAspectRatio:dest.height;if(scaleDownWidth>s.width||scaleDownHeight>s.height){dWidth=s.width;dHeight=s.height}else{if(imgAspectRatio>destAspectRatio){dHeight=dest.width/imgAspectRatio;dy+=(dest.height-dHeight)/2}else{dWidth=dest.height*imgAspectRatio;dx+=(dest.width-dWidth)/2}}break;case"fill":default:break}this.ctx.drawImage(s.image,src.x,src.y,src.width,src.height,dx,dy,dWidth,dHeight);this.ctx.restore();this.ctx._saveCount=(this.ctx._saveCount||1)-1}get(key){const s=this.sprites[key];if(!s){console.log("Missing image: "+key);return}return s}slice_9(key,dest,x_margin=90,y_margin=90){const s=this.sprites[key];if(!s){console.log("Missing image: "+key);return}let dx=Math.round(dest.x);let dy=Math.round(dest.y);let dw=Math.round(dest.width);let dh=Math.round(dest.height);let top_y=dy;let top_h=y_margin;let mid_y=top_y+top_h;let mid_h=dh-y_margin-y_margin;let bot_y=mid_y+mid_h;let bot_h=dy+dh-bot_y;let left_x=dx;let left_w=x_margin;let center_x=left_x+left_w;let center_w=dw-x_margin-x_margin;let right_x=center_x+center_w;let right_w=dx+dw-right_x;this.ctx.drawImage(s.image,s.x,s.y,x_margin,y_margin,left_x,top_y,left_w,top_h);this.ctx.drawImage(s.image,s.x+x_margin,s.y,s.width-x_margin*2,y_margin,center_x,top_y,center_w,top_h);this.ctx.drawImage(s.image,s.x+s.width-x_margin,s.y,x_margin,y_margin,right_x,top_y,right_w,top_h);this.ctx.drawImage(s.image,s.x,s.y+y_margin,x_margin,s.height-y_margin*2,left_x,mid_y,left_w,mid_h);this.ctx.drawImage(s.image,s.x+x_margin,s.y+y_margin,s.width-x_margin*2,s.height-y_margin*2,center_x,mid_y,center_w,mid_h);this.ctx.drawImage(s.image,s.x+s.width-x_margin,s.y+y_margin,x_margin,s.height-y_margin*2,right_x,mid_y,right_w,mid_h);this.ctx.drawImage(s.image,s.x,s.y+s.height-y_margin,x_margin,y_margin,left_x,bot_y,left_w,bot_h);this.ctx.drawImage(s.image,s.x+x_margin,s.y+s.height-y_margin,s.width-x_margin*2,y_margin,center_x,bot_y,center_w,bot_h);this.ctx.drawImage(s.image,s.x+s.width-x_margin,s.y+s.height-y_margin,x_margin,y_margin,right_x,bot_y,right_w,bot_h)}slice_3(key,dest){const s=this.sprites[key];if(!s){console.log("Missing image: "+key);return}let x_margin=90;let source_outer=new rect(s.x,s.y,s.width,s.height);let source_inner=new rect(s.x+x_margin,s.y,s.width-x_margin*2,s.height);let dest_outer=new rect(dest.x,dest.y,dest.width,dest.height);let dest_inner=new rect(dest.x+x_margin,dest.y,dest.width-x_margin*2,dest.height);source_outer.round();source_inner.round();dest_outer.round();dest_inner.round();let source_grid=new grid(source_outer,source_inner,3);let dest_grid=new grid(dest_outer,dest_inner,3);for(let index=0;index<3;index++){let dx=dest_grid.quadrants[index].x;let dy=dest_grid.quadrants[index].y;let dWidth=dest_grid.quadrants[index].width;let dHeight=dest_grid.quadrants[index].height;let sx=source_grid.quadrants[index].x;let sy=source_grid.quadrants[index].y;let sWidth=source_grid.quadrants[index].width;let sHeight=source_grid.quadrants[index].height;if([0,2].includes(index)){this.ctx.drawImage(s.image,sx,sy,sWidth,sHeight,dx,dy,dWidth,dHeight)}if([1].includes(index)){this.ctx.drawImage(s.image,sx,sy,sWidth,sHeight,dx,dy,dWidth,dHeight)}}}clear(color,position){this.ctx.fillStyle=color;this.ctx.fillRect(position.x,position.y,position.width,position.height)}}class sprite_font{constructor(ctx,sprites,image_key,logger,viewport){this.sprites=sprites;this.ctx=ctx;this.viewport=viewport;this.logger=logger||console;this.characters="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,;:?!-_~#\"'&()[]|`\\/@"+"°+=*$£€<>";this.image=this.sanitize_path(image_key);this.spacing_width=1;this.mono_char_width=22;this.mono_char_height=27;this.char_width=46;this.char_height=43;this.chars_per_row=5;this.char_data=[];this.sprite=this.sprites.get(this.image);this.calculate_char_data()}sanitize_path(path){if(typeof path!=="string"){throw new Error("Invalid image key type")}return path.replace(/[<>"'`;]/g,"")}calculate_char_data(){try{const canvas=document.createElement("canvas");const ctx=canvas.getContext("2d",{willReadFrequently:true});for(let i=0;i<this.characters.length;i++){const char=this.characters[i];const sx=i%this.chars_per_row*this.char_width;const sy=Math.floor(i/this.chars_per_row)*this.char_height;let sub_rect=new rect(sx,sy,this.char_width,this.char_height);const char_bounds=this.sprites.get_bounds(this.image,sub_rect);const char_data={character:char,left:char_bounds.left+sx,top:char_bounds.top+sy,right:char_bounds.right+sx,bottom:char_bounds.bottom+sy,width:char_bounds.right-char_bounds.left,height:char_bounds.bottom-char_bounds.top,stride:char_bounds.right-char_bounds.left+1,baseline:char_bounds.top};this.char_data.push(char_data)}}catch(error){this.logger.error(`calculate_char_data: ${error.message}`);throw error}}get_character(char){try{return this.char_data.find(char_data=>char_data.character===char)}catch(error){this.logger.error(`get_character(${char}): ${error.message}`);return null}}get_bounds(text,monospace=false){try{let x=0,y=0,max_x=0;for(let i=0;i<text.length;i++){const char=text[i];if(char===" "){x+=this.mono_char_width;continue}if(char==="\n"){y+=this.mono_char_height;max_x=Math.max(max_x,x);x=0;continue}const char_data=this.get_character(char);if(!char_data)continue;if(monospace){x+=this.mono_char_width}else{if(i<text.length-1)x+=this.spacing_width;x+=char_data.width}}if(y===0)y=this.mono_char_height;max_x=Math.max(max_x,x);return new rect(0,0,max_x,y,"left","top")}catch(error){this.logger.error(`get_bounds: ${error.message}`)}}draw_text(position,text,centered=false,monospace=false){try{let lines=text.split("\n");if(centered){position.y=position.center_y-lines.length*this.mono_char_height/2}for(let line in lines){this.draw_single_text(position,lines[line],centered,monospace);position.y+=this.mono_char_height}}catch(error){this.logger.error(`draw_text: ${error.message}`)}}draw_single_text(position,text,centered=false,monospace=false){try{if(!this.chars_per_row){this.logger.error("draw_single_text: Image not loaded");return}let pos_x,padding=0;let pos_y=position.y;if(centered){pos_x=position.center_x}else{pos_x=position.x}if(centered){let bounds=this.get_bounds(text,monospace);pos_x-=bounds.center_x}for(let i=0;i<text.length;i++){const char=text[i];if(char===" "){pos_x+=this.mono_char_width;continue}if(char==="\n")return;const char_data=this.get_character(char);if(!char_data)continue;this.ctx.drawImage(this.sprite.image,char_data.left,char_data.top,char_data.width,char_data.height,pos_x+padding,pos_y+char_data.baseline,char_data.width,char_data.height);if(monospace){pos_x+=this.mono_char_width}else{pos_x+=char_data.width+this.spacing_width}padding=0}}catch(error){this.logger.error(`draw_single_text: ${error.message}`)}}}class button extends events{constructor(parent,graphics,label,position,anchor_position,callback,up_image,down_image,logger){super();this.logger=logger||console;try{this.parent=parent;this.graphics=graphics;this.ctx=graphics.ctx;this.sprites=graphics.sprites;this.up_image=this.sanitize_path(up_image);this.down_image=this.sanitize_path(down_image);this.label=label;this.is_down=false;this.is_hover=false;this.monospaced=false;this.centered=false;this.active=true;let x_pad=20;let y_pad=20;let bounds=this.graphics.font.get_bounds(label,this.monospaced);if(position.width==null)position.width=bounds.width+x_pad*2;if(position.height==null)position.height=bounds.height+y_pad*2;this.inner=new rect((position.width-bounds.width)/2,(position.height-bounds.height)/2,bounds.width,bounds.height);this.position=position;this.anchor_position=anchor_position;this._bound_mouse_down=this.handle_mouse_down.bind(this);this._bound_mouse_up=this.handle_mouse_up.bind(this);this._bound_mouse_move=this.handle_mouse_move.bind(this);graphics.canvas.addEventListener("mousedown",this._bound_mouse_down);graphics.canvas.addEventListener("mouseup",this._bound_mouse_up);graphics.canvas.addEventListener("mousemove",this._bound_mouse_move);this.callback=callback}catch(error){this.logger.error(`button constructor: ${error.message}`);throw error}}sanitize_path(path){if(typeof path!=="string"){throw new Error("Invalid path type")}return path.replace(/[<>"'`;]/g,"")}resize(anchor_position){try{this.anchor_position=anchor_position}catch(error){this.logger.error(`resize: ${error.message}`)}}render(){try{if(this.active!==true)return;let relative_position=this.position.clone();let relative_inner=this.inner.clone();relative_position.add(this.anchor_position);relative_inner.add(relative_position);let img=this.up_image;if(this.is_down){img=this.down_image}else if(this.is_hover){relative_position.x+=2;relative_position.y+=2;relative_inner.x+=2;relative_inner.y+=2}this.sprites.slice_9(img,relative_position,10,10);this.graphics.font.draw_text(relative_inner,this.label,this.centered,this.monospaced)}catch(error){this.logger.error(`render: ${error.message}`)}}handle_mouse_down(event){try{if(this.active!==true)return;if(this.is_down)return;if(this.is_inside(event.offsetX,event.offsetY)){this.is_down=true}}catch(error){this.logger.error(`handle_mouse_down: ${error.message}`)}}handle_mouse_up(event){try{if(this.active!==true)return;if(this.is_down&&this.is_inside(event.offsetX,event.offsetY)){if(this.is_down===true){if(this.callback){this.callback.bind(this.parent)({parent:this.parent,event:event,instance:this})}this.emit("click",event)}}this.is_down=false}catch(error){this.logger.error(`handle_mouse_up: ${error.message}`)}}handle_mouse_move(event){try{if(this.active!==true)return;let previously_hover=this.is_hover;this.is_hover=this.is_inside(event.offsetX,event.offsetY);if(this.is_hover&&!previously_hover){this.emit("mouseover",event)}else if(!this.is_hover&&previously_hover){this.emit("mouseout",event)}}catch(error){this.logger.error(`handle_mouse_move: ${error.message}`)}}is_inside(mouse_x,mouse_y){try{const viewport=this.graphics.viewport;const scale=viewport.scale;const renderedWidth=viewport.virtual.width*scale.x;const renderedHeight=viewport.virtual.height*scale.y;const offsetX=(viewport.given.width-renderedWidth)/2;const offsetY=(viewport.given.height-renderedHeight)/2;const virtual_mouse_x=(mouse_x-offsetX)/scale.x;const virtual_mouse_y=(mouse_y-offsetY)/scale.y;let relative_position=this.position.clone();relative_position.add(this.anchor_position);return virtual_mouse_x>=relative_position.x&&virtual_mouse_x<=relative_position.x+relative_position.width&&virtual_mouse_y>=relative_position.y&&virtual_mouse_y<=relative_position.y+relative_position.height}catch(error){this.logger.error(`is_inside: ${error.message}`);return false}}set_active(active){try{this.active=active}catch(error){this.logger.error(`set_active: ${error.message}`)}}delete(){try{this.graphics.canvas.removeEventListener("mousedown",this._bound_mouse_down);this.graphics.canvas.removeEventListener("mouseup",this._bound_mouse_up);this.graphics.canvas.removeEventListener("mousemove",this._bound_mouse_move);delete this.parent;delete this.graphics;delete this.ctx;delete this.sprites;delete this.up_image;delete this.down_image;delete this.label;delete this.is_down;delete this.is_hover;delete this.monospaced;delete this.centered;delete this.active;delete this.inner;delete this.position;delete this.anchor_position;delete this.callback;delete this._bound_mouse_down;delete this._bound_mouse_up;delete this._bound_mouse_move}catch(error){this.logger.error(`delete: ${error.message}`)}}}class seekbar extends events{constructor(parent,graphics,position,anchor_position,get_progress_callback,seek_callback,logger){super();this.logger=logger||console;try{this.parent=parent;this.graphics=graphics;this.ctx=graphics.ctx;this.position=position;this.anchor_position=anchor_position;this.get_progress_callback=get_progress_callback;this.seek_callback=seek_callback;this.active=true;this.is_dragging=false;this._bound_mouse_down=this.handle_mouse_down.bind(this);this._bound_mouse_up=this.handle_mouse_up.bind(this);this._bound_mouse_move=this.handle_mouse_move.bind(this);graphics.canvas.addEventListener("mousedown",this._bound_mouse_down);graphics.canvas.addEventListener("mouseup",this._bound_mouse_up);graphics.canvas.addEventListener("mousemove",this._bound_mouse_move)}catch(error){this.logger.error(`seekbar constructor: ${error.message}`);throw error}}resize(anchor_position){try{this.anchor_position=anchor_position}catch(error){this.logger.error(`resize: ${error.message}`)}}render(){try{if(this.active!==true)return;if(!this.ctx||!this.graphics||!this.position||!this.anchor_position)return;const progress_data=this.get_progress_callback();if(!progress_data)return;const{current,total,paused}=progress_data;if(typeof current!=="number"||typeof total!=="number")return;let relative_position=this.position.clone();relative_position.add(this.anchor_position);const seekbar_x=relative_position.x;const seekbar_y=relative_position.y;const seekbar_width=this.position.width;const seekbar_height=this.position.height;const progress=total>0?Math.min(1,current/total):0;this.ctx.save();this.ctx.fillStyle="rgba(100, 100, 100, 0.8)";this.ctx.fillRect(seekbar_x,seekbar_y,seekbar_width,seekbar_height);this.ctx.fillStyle="rgba(0, 255, 255, 0.8)";this.ctx.fillRect(seekbar_x,seekbar_y,seekbar_width*progress,seekbar_height);const handle_x=seekbar_x+seekbar_width*progress;const handle_width=10;this.ctx.fillStyle="#00FFFF";this.ctx.fillRect(handle_x-handle_width/2,seekbar_y-5,handle_width,seekbar_height+10);const current_time_str=this.format_time(current/1e3);const total_time_str=this.format_time(total/1e3);this.ctx.fillStyle="#FFFFFF";this.ctx.font="14px monospace";this.ctx.textAlign="left";this.ctx.fillText(`${current_time_str} / ${total_time_str}`,seekbar_x,seekbar_y-10);this.ctx.textAlign="right";this.ctx.fillText(paused?"[PAUSED]":"[PLAYING]",seekbar_x+seekbar_width,seekbar_y-10);this.ctx.restore()}catch(error){this.logger.error(`render: ${error.message}`)}}format_time(seconds){const mins=Math.floor(seconds/60);const secs=Math.floor(seconds%60);return`${mins}:${secs.toString().padStart(2,"0")}`}handle_mouse_down(event){try{if(this.active!==true)return;if(this.is_inside(event.offsetX,event.offsetY)){this.is_dragging=true;this.emit("seek_start");this.handle_seek(event.offsetX,event.offsetY)}}catch(error){this.logger.error(`handle_mouse_down: ${error.message}`)}}handle_mouse_up(event){try{if(this.active!==true)return;if(this.is_dragging){this.is_dragging=false;this.emit("seek_end")}}catch(error){this.logger.error(`handle_mouse_up: ${error.message}`)}}handle_mouse_move(event){try{if(this.active!==true)return;if(this.is_dragging){this.handle_seek(event.offsetX,event.offsetY)}}catch(error){this.logger.error(`handle_mouse_move: ${error.message}`)}}handle_seek(mouse_x,mouse_y){try{const progress_data=this.get_progress_callback();if(!progress_data)return;const viewport=this.graphics.viewport;const scale=viewport.scale;const renderedWidth=viewport.virtual.width*scale.x;const renderedHeight=viewport.virtual.height*scale.y;const offsetX=(viewport.given.width-renderedWidth)/2;const offsetY=(viewport.given.height-renderedHeight)/2;const virtual_mouse_x=(mouse_x-offsetX)/scale.x;let relative_position=this.position.clone();relative_position.add(this.anchor_position);const seekbar_x=relative_position.x;const seekbar_width=this.position.width;const click_ratio=Math.max(0,Math.min(1,(virtual_mouse_x-seekbar_x)/seekbar_width));const new_time=progress_data.total*click_ratio;if(this.seek_callback){this.seek_callback(new_time)}this.emit("seek",{time:new_time,ratio:click_ratio})}catch(error){this.logger.error(`handle_seek: ${error.message}`)}}is_inside(mouse_x,mouse_y){try{if(this.active!==true||!this.position||!this.anchor_position)return false;const viewport=this.graphics.viewport;const scale=viewport.scale;const renderedWidth=viewport.virtual.width*scale.x;const renderedHeight=viewport.virtual.height*scale.y;const offsetX=(viewport.given.width-renderedWidth)/2;const offsetY=(viewport.given.height-renderedHeight)/2;const virtual_mouse_x=(mouse_x-offsetX)/scale.x;const virtual_mouse_y=(mouse_y-offsetY)/scale.y;let relative_position=this.position.clone();relative_position.add(this.anchor_position);const clickable_padding=5;return virtual_mouse_x>=relative_position.x&&virtual_mouse_x<=relative_position.x+this.position.width&&virtual_mouse_y>=relative_position.y-clickable_padding&&virtual_mouse_y<=relative_position.y+this.position.height+clickable_padding}catch(error){this.logger.error(`is_inside: ${error.message}`);return false}}set_active(active){try{this.active=active}catch(error){this.logger.error(`set_active: ${error.message}`)}}delete(){try{this.active=false;if(this.graphics&&this.graphics.canvas){this.graphics.canvas.removeEventListener("mousedown",this._bound_mouse_down);this.graphics.canvas.removeEventListener("mouseup",this._bound_mouse_up);this.graphics.canvas.removeEventListener("mousemove",this._bound_mouse_move)}delete this.parent;delete this.graphics;delete this.ctx;delete this.position;delete this.anchor_position;delete this.get_progress_callback;delete this.seek_callback;delete this.is_dragging;delete this._bound_mouse_down;delete this._bound_mouse_up;delete this._bound_mouse_move}catch(error){if(this.logger){this.logger.error(`delete: ${error.message}`)}}}}class modal{constructor(logger){this.logger=logger||console;try{this.window_manager=null;this.parent=null;this.graphics=null;this.active=false;this.events={};this.ok=null;this.cancel=null;this.closeButton=null;this.title=null;this.text=null;this.position=null;this.skin=true;this.external_render_callback=null;this.background=null;this.bg_gradient=null;this.buttons=[];this.images=[];this.ui_components=[];this.no_close=false;this.kb=null}catch(error){this.logger.error(`modal constructor: ${error.message}`)}}init(window_manager){try{this.window_manager=window_manager;this.graphics=window_manager.graphics;this.audio_manager=window_manager.audio_manager;this.canvas=this.graphics.canvas;this.sprites=this.graphics.sprites;this.kb=new key_states}catch(error){this.logger.error(`init: ${error.message}`)}}add_bg_gradient(percentage,color){try{if(this.bg_gradient==null){this.bg_gradient=[]}this.bg_gradient.push([percentage,color])}catch(error){this.logger.error(`add_bg_gradient: ${error.message}`)}}layout2(position,title,text,cancel=false,ok=true,close=false){try{this.active=true;this.ok=ok;this.cancel=cancel;this.closeButton=close;this.title=title;this.text=text;this.position=position}catch(error){this.logger.error(`layout2: ${error.message}`)}}no_skin(){try{this.skin=false}catch(error){this.logger.error(`no_skin: ${error.message}`)}}set_background(background){try{if(typeof background==="string"){background=this.sanitize_path(background)}this.background=background}catch(error){this.logger.error(`set_background: ${error.message}`)}}sanitize_path(path){try{if(typeof path!=="string"){throw new Error("Invalid background path type")}return path.replace(/[<>"'`;]/g,"")}catch(error){this.logger.error(`sanitize_path: ${error.message}`);throw error}}add_buttons(){try{let mode="center";this._bound_handle_key_down=this.handle_key_down.bind(this);if(this.closeButton){let button_position=new rect(this.position.width-50,-20,42,42);let anchor_position=new rect(0,0,0,0);anchor_position.add(this.position);this.closeButton=new button(this,this.graphics,"",button_position,anchor_position,null,"window-close-up","window-close-down");this.closeButton.on("click",()=>{this.close()})}if(this.ok){let button_position=new rect(this.position.left+100,this.position.bottom-60);let ok_instance=this.add_button("Ok",button_position,null,"button-up-cyan","button-down-cyan");ok_instance.on("click",()=>{this.emit("ok",{instance:this})})}if(this.cancel){let button_position=new rect(this.position.right-100,this.position.bottom-60);let cancel_instance=this.add_button("Cancel",button_position,mode,"button-up-red","button-down-red");cancel_instance.on("click",()=>{this.emit("cancel",{instance:this})})}document.addEventListener("keydown",this._bound_handle_key_down)}catch(error){this.logger.error(`add_buttons: ${error.message}`)}}update_keyboard_state(key,is_down){try{if(!this.kb)return;if(is_down){this.kb.down(key)}else{this.kb.up(key)}}catch(error){this.logger.error(`update_keyboard_state: ${error.message}`)}}handle_keys(){try{if(!this.active||!this.kb)return;this.emit("keys",{kb:this.kb});if(this.kb.just_stopped("Escape")){let escapeEvent={instance:this,defaultPrevented:false};this.emit("escape",escapeEvent);if(!this.no_close&&!escapeEvent.defaultPrevented){this.close()}}}catch(error){this.logger.error(`handle_keys: ${error.message}`)}}resize(){try{this.title_position=new rect(160/2,-20,this.position.width-160,80,"left","top");let x_padding=34;let y_padding=[30,50];let y_offset=0;if(this.skin===false){x_padding=0;y_padding=[0,0];y_offset=0}this.internal_rect=new rect(x_padding,y_offset+y_padding[0],this.position.width-x_padding*2,this.position.height-y_offset-y_padding[0]-y_padding[1],"left","top");this.render_position=this.position.clone();this.render_title_position=this.title_position.clone();this.render_internal_rect=this.internal_rect.clone();this.render_title_position.add(this.render_position);this.render_internal_rect.add(this.render_position);for(let i=0;i<this.buttons.length;i++){this.buttons[i].resize(this.render_internal_rect)}if(this.closeButton&&typeof this.closeButton.resize==="function"){this.closeButton.resize(this.render_position)}for(let i=0;i<this.ui_components.length;i++){if(this.ui_components[i].resize){this.ui_components[i].resize(this.render_internal_rect)}}}catch(error){this.logger.error(`resize: ${error.message}`)}}create_button(label,position,callback,up_image,down_image){try{let anchor_position=new rect(0,0,0,0);anchor_position.add(this.position);anchor_position.add(this.internal_rect);let new_button=new button(this,this.graphics,label,position,anchor_position,callback,up_image,down_image);new_button.on("click",()=>{this.emit("click",{instance:this})});return new_button}catch(error){this.logger.error(`create_button: ${error.message}`);return null}}add_button(label,position,callback,up_image,down_image){try{let new_button=this.create_button(label,position,callback,up_image,down_image);if(new_button){this.buttons.push(new_button)}return new_button}catch(error){this.logger.error(`add_button: ${error.message}`);return null}}add_image(position,key){try{let image={position:position,key:key};this.images.push(image);return image}catch(error){this.logger.error(`add_image: ${error.message}`);return null}}del_image(image){try{const index=this.images.findIndex(img=>img.key===image.key);if(index!==-1){this.images.splice(index,1);return true}return false}catch(error){this.logger.error(`del_image: ${error.message}`);return false}}render_callback(callback){try{this.external_render_callback=callback}catch(error){this.logger.error(`render_callback: ${error.message}`)}}handle_key_down(event){try{if(this.active!==true)return;if(event.key==="Escape"&&!this.no_close){this.close();event.preventDefault();event.stopPropagation();return}this.emit("keydown",{instance:this,event:event})}catch(error){this.logger.error(`handle_key_down: ${error.message}`)}}on(event_name,callback){try{if(!this.events[event_name]){this.events[event_name]=[]}this.events[event_name].push(callback)}catch(error){this.logger.error(`on(${event_name}): ${error.message}`)}}emit(event_name,data){try{if(this.events[event_name]){this.events[event_name].forEach(callback=>{try{callback(data)}catch(cbError){this.logger.error(`emit(${event_name}) callback error: ${cbError.message}`)}})}}catch(error){this.logger.error(`emit(${event_name}): ${error.message}`)}}render(){try{if(this.active===false)return;if(!this.graphics||!this.graphics.ctx)return;if(!this.sprites)return;if(!this.render_position||!this.internal_rect||!this.render_internal_rect)return;const ctx=this.graphics.ctx;if(!ctx||typeof ctx.save!=="function")return;if(this.skin){this.sprites.slice_9("window",this.render_position)}ctx.save();ctx.beginPath();ctx.rect(this.render_internal_rect.x,this.render_internal_rect.y,this.render_internal_rect.width,this.render_internal_rect.height);ctx.clip();if(this.external_render_callback!=null){this.external_render_callback(this.render_internal_rect)}if(this.buttons){this.buttons.forEach(button=>button.render())}if(this.ui_components){this.ui_components.forEach(component=>component.render())}if(this.text){this.graphics.font.draw_text(this.render_internal_rect,this.text,true,true)}ctx.restore();if(this.images){for(let i=0;i<this.images.length;i++){let image=this.images[i];let image_pos=image.position.clone();this.graphics.sprites.render(image.key,null,image_pos,1,"contain")}}if(this.skin&&this.sprites&&this.graphics.font){this.sprites.slice_3("window-title",this.render_title_position);this.graphics.font.draw_text(this.render_title_position,this.title,true,false)}if(this.closeButton!=null&&typeof this.closeButton.render==="function"){this.closeButton.render()}}catch(error){this.logger.error(`render: ${error.message}`)}}set_active(active){try{this.active=active;if(this.buttons){this.buttons.forEach(button=>button.set_active(active))}if(this.ui_components){this.ui_components.forEach(component=>component.set_active(active))}}catch(error){this.logger.error(`set_active: ${error.message}`)}}close(){try{if(this.active!==true)return;this.emit("close",{instance:this});this.logger.info("Modal: Close Window");this.delete()}catch(error){this.logger.error(`close: ${error.message}`)}}delete(){try{this.active=false;if(this._bound_handle_key_down){document.removeEventListener("keydown",this._bound_handle_key_down)}this.events={};if(this.buttons){this.buttons.forEach(button=>button.delete())}if(this.ui_components){this.ui_components.forEach(component=>component.delete())}delete this.parent;delete this.graphics;delete this.canvas;delete this.sprites;delete this.ok;delete this.cancel;delete this.title;delete this.text;delete this.position;delete this.external_render_callback;delete this.buttons;delete this.images}catch(error){this.logger.error(`delete: ${error.message}`)}}}class viewport{constructor(width,height){this.frame={x:0,y:0,width:0,height:0};this.requested={width:width,height:height};this.virtual={width:0,height:0};this.given={x:0,y:0,width:0,height:0};this.world={x:0,y:0,width:0,height:0};this.scale={x:1,y:1};this.calculate()}calculate(){this.frame={x:0,y:0,width:window.innerWidth,height:window.innerHeight};if(this.requested.width<this.frame.width){this.given.width=this.requested.width;this.given.height=this.requested.height;this.given.width=this.frame.width;this.given.height=this.frame.height}else{this.given.width=this.frame.width;this.given.height=this.frame.height}this.given.x=(this.frame.width-this.given.width)/2;this.given.y=(this.frame.height-this.given.height)/2;this.calculate_scale();this.world.height=this.virtual.height;this.world.width=this.virtual.height}calculate_scale(){this.virtual.width=this.requested.width;this.virtual.height=this.requested.height;const scaleX=this.given.width/this.virtual.width;const scaleY=this.given.height/this.virtual.height;const uniformScale=Math.min(scaleX,scaleY);this.scale.x=uniformScale;this.scale.y=uniformScale}}class window_manager extends events{constructor(elements){super();this.canvas=document.getElementById(elements.canvasId);this.ctx=this.canvas.getContext("2d");this.graphics=new graphics(this.canvas,this.ctx);this.audio_manager=new audio_manager;this.modals=[];this.active_modal=null;this.boss_mode_activated=false;this.kb=new key_states;this.debug_frame_step=false;this.debug_render_next_frame=false;this.debug_frame_count=0;window.addEventListener("keydown",event=>{this.kb.down(event.key);this.kb.event(event);if(event.key==="F12"){this.debug_frame_step=!this.debug_frame_step;console.log("[DEBUG] Frame stepping:",this.debug_frame_step?"ENABLED - Press F11 to render next frame":"DISABLED");event.preventDefault();return}if(event.key==="F11"){if(this.debug_frame_step){this.debug_render_next_frame=true;console.log("[DEBUG] ========== RENDERING FRAME",++this.debug_frame_count,"==========")}event.preventDefault();return}if(this.active_modal&&this.active_modal.update_keyboard_state){this.active_modal.update_keyboard_state(event.key,true)}switch(event.key){case"F5":break;default:event.preventDefault()}});window.addEventListener("keyup",event=>{this.kb.up(event.key);this.kb.event(event);if(this.active_modal&&this.active_modal.update_keyboard_state){this.active_modal.update_keyboard_state(event.key,false)}switch(event.key){case"F5":break;case"F11":break;case"F12":break;default:event.preventDefault()}});setInterval(()=>{if(this.debug_frame_step&&!this.debug_render_next_frame){return}this.debug_render_next_frame=false;this.graphics.recalc_canvas();if(this.has_windows()>0){this.handle_keys();this.resize();this.render()}},1e3/24)}has_windows(){if(this.modals.length>0)return true;return false}add(modal_instance){modal_instance.init(this);modal_instance.layout();this.insert_model(modal_instance)}create_modal(title,text,position,cancel=false,ok=true,close=false){const modal_instance=new modal(this,this.graphics,position,title,text,cancel,ok,close);return this.insert_model(modal_instance)}insert_model(modal_instance){modal_instance.on("close",()=>{this.close_modal(modal_instance)});this.modals.forEach(modal=>modal.set_active(false));this.modals.push(modal_instance);this.active_modal=modal_instance;return modal_instance}close_modal(modal_instance){const index=this.modals.indexOf(modal_instance);if(index>-1){this.modals.splice(index,1)}this.active_modal=null;if(this.modals.length>0){let last_modal=this.modals[this.modals.length-1];last_modal.set_active(true);this.active_modal=last_modal}}handle_keys(){if(this.kb.just_stopped("Tab")){if(this.boss_mode_activated){this.boss_mode_off()}else{this.boss_mode_on()}return}if(this.kb.just_stopped("Escape")&&this.boss_mode_activated){this.boss_mode_off();return}if(this.active_modal&&!this.boss_mode_activated){this.active_modal.handle_keys()}}boss_mode_on(){document.getElementById("game").style.display="none";document.getElementById("boss_mode").style.display="block";this.boss_mode_activated=true;if(this.audio_manager){this.audio_manager.sound_off()}}boss_mode_off(){document.getElementById("game").style.display="block";document.getElementById("boss_mode").style.display="none";this.boss_mode_activated=false;if(this.audio_manager){this.audio_manager.sound_on()}}resize(){for(let i=0;i<this.modals.length;i++)this.modals[i].resize()}render(){if(this.active_modal){const initialSaveCount=this.graphics.ctx._saveCount||0;this.graphics.ctx.save();this.graphics.ctx._saveCount=(this.graphics.ctx._saveCount||0)+1;const baseGradient=this.graphics.ctx.createLinearGradient(0,0,0,this.graphics.viewport.given.height);baseGradient.addColorStop(0,"#0a1628");baseGradient.addColorStop(.5,"#06292e");baseGradient.addColorStop(1,"#0d1b2a");this.graphics.ctx.fillStyle=baseGradient;this.graphics.ctx.fillRect(0,0,this.graphics.viewport.given.width,this.graphics.viewport.given.height);const scale=this.graphics.viewport.scale;const viewport=this.graphics.viewport;const renderedWidth=viewport.virtual.width*scale.x;const renderedHeight=viewport.virtual.height*scale.y;const offsetX=(viewport.given.width-renderedWidth)/2;const offsetY=(viewport.given.height-renderedHeight)/2;this.graphics.ctx.translate(offsetX,offsetY);this.graphics.ctx.scale(scale.x,scale.y);if(this.active_modal.background){const bgRect=new rect(0,0,this.graphics.viewport.virtual.width,this.graphics.viewport.virtual.height);this.graphics.sprites.render(this.active_modal.background,null,bgRect,1,"contain")}if(this.active_modal.bg_gradient){var gradient=this.graphics.ctx.createLinearGradient(0,0,0,this.graphics.viewport.virtual.height);for(let i=0;i<this.active_modal.bg_gradient.length;i++)gradient.addColorStop(this.active_modal.bg_gradient[i][0],this.active_modal.bg_gradient[i][1]);this.graphics.ctx.fillStyle=gradient;this.graphics.ctx.fillRect(0,0,this.graphics.viewport.virtual.width,this.graphics.viewport.virtual.height)}this.active_modal.render();this.graphics.ctx.restore();this.graphics.ctx._saveCount=(this.graphics.ctx._saveCount||1)-1;const finalSaveCount=this.graphics.ctx._saveCount||0;if(finalSaveCount!==initialSaveCount){console.error(`[CTX LEAK] Save/restore mismatch! Initial: ${initialSaveCount}, Final: ${finalSaveCount}, Modal: ${this.active_modal.constructor.name}`)}}}}class graphics extends events{constructor(canvas=null,ctx=null,logger){super(logger);this.logger=logger||console;try{this.canvas=canvas;this.ctx=ctx;this.font=null;this.sprites=new sprites(ctx);this.sprites.on("complete",this.load_font.bind(this));this.sprites.preload();this.backround=null;this.viewport=new viewport(1920,1080);this.frame_background_color="#222";this.background_color="#000000"}catch(error){this.logger.error(`graphics constructor: ${error.message}`)}}sanitize_path(path){if(typeof path!=="string"){throw new Error("Invalid image URL type")}return path.replace(/[<>"'`;]/g,"")}load_font(){try{let font=new sprite_font(this.ctx,this.sprites,"grey_font",this.logger,this.viewport);this.font=font;this.emit("complete")}catch(error){this.logger.error(`load_font: ${error.message}`)}}set_background(image_url){try{image_url=this.sanitize_path(image_url);this.backround=new Image;this.backround.src=image_url}catch(error){this.logger.error(`set_background: ${error.message}`)}}recalc_canvas(){try{this.viewport.calculate();this.canvas.windowWidth=this.viewport.frame.width;this.canvas.windowHeight=this.viewport.frame.height;this.canvas.width=this.viewport.frame.width;this.canvas.height=this.viewport.frame.height}catch(error){this.logger.error(`recalc_canvas: ${error.message}`)}}updateCanvasSizeAndDrawImage(level_position){try{if(this.backround==null){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);return}let srcX=0;let srcY=0;let destX=this.viewport.given.x;let destY=this.viewport.given.y;let scaledDestWidth=this.viewport.given.width;let scaledDestHeight=this.viewport.given.height;let vp_h=this.viewport.virtual.height;let scrollable_height=level_position.height-vp_h;if(scrollable_height<0)scrollable_height=0;let position_percentage=scrollable_height/level_position.y;srcY=position_percentage*scrollable_height;position_percentage=level_position.y/(level_position.height-this.viewport.virtual.height);srcY=position_percentage*(this.backround.height-this.viewport.virtual.height);this.ctx.save();this.ctx.fillStyle=this.frame_background_color;this.ctx.fillRect(this.viewport.frame.x,this.viewport.frame.y,this.viewport.frame.width,this.viewport.frame.height);this.ctx.restore();this.ctx.fillStyle=this.background_color;let bg_scale_x=this.viewport.given.width/this.backround.width;let bg_h=this.viewport.virtual.height;this.ctx.drawImage(this.backround,srcX,srcY,this.backround.width,bg_h,destX,destY,scaledDestWidth,scaledDestHeight)}catch(error){this.logger.error(`updateCanvasSizeAndDrawImage: ${error.message}`)}}fade_images(percentage){try{if(!this.ctx||!this.canvas){this.logger.error("fade_images: Canvas or context not defined");return}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.ctx.globalAlpha=1;this.ctx.drawImage(image1,0,0,this.canvas.width,this.canvas.height);this.ctx.globalAlpha=percentage/100;this.ctx.drawImage(image2,0,0,this.canvas.width,this.canvas.height);this.ctx.globalAlpha=1}catch(error){this.logger.error(`fade_images: ${error.message}`)}}}class key_states{constructor(logger){this.logger=logger||console;try{this.states=[];this.shift_state=false;this.ctrl_state=false}catch(error){this.logger.error(`key_states constructor: ${error.message}`)}}up(key){try{if(!this.states[key]||!this.states[key].justStopped){this.states[key]={pressed:false,up:true,down:false,justStopped:true}}}catch(error){this.logger.error(`up(${key}): ${error.message}`)}}down(key){try{if(!this.states[key]||!this.states[key].justPressed){this.states[key]={pressed:true,up:false,down:true,justPressed:true}}}catch(error){this.logger.error(`down(${key}): ${error.message}`)}}get_state(key){try{if(key in this.states){return this.states[key]}this.states[key]={pressed:false,up:false,down:false};return this.states[key]}catch(error){this.logger.error(`get_state(${key}): ${error.message}`);return{pressed:false,up:false,down:false}}}is_pressed(key){try{return key in this.states&&this.states[key].pressed}catch(error){this.logger.error(`is_pressed(${key}): ${error.message}`);return false}}just_pressed(key){try{if(key in this.states&&this.states[key].justPressed){this.states[key].justPressed=false;return true}return false}catch(error){this.logger.error(`just_pressed(${key}): ${error.message}`);return false}}just_stopped(key){try{if(key in this.states&&this.states[key].justStopped){this.states[key].justStopped=false;return true}return false}catch(error){this.logger.error(`just_stopped(${key}): ${error.message}`);return false}}shift(){try{return this.shift_state}catch(error){this.logger.error(`shift(): ${error.message}`);return false}}ctrl(){try{return this.ctrl_state}catch(error){this.logger.error(`ctrl(): ${error.message}`);return false}}event(event){try{this.shift_state=event.shiftKey;this.ctrl_state=event.ctrlKey}catch(error){this.logger.error(`event(): ${error.message}`)}}}class menu extends modal{constructor(){super();this.menu_buttons=[];this.title_image=null;this.glow_phase=0}layout(){this.set_background("menu");this.ok=false;this.cancel=false;this.closeButton=false;this.no_close=true;this.title="Menu";this.text="";this.active=true;let vw=this.graphics.viewport.virtual.width;let vh=this.graphics.viewport.virtual.height;let window_width=400;let window_height=600;let x=60;let y=(vh-window_height)/2;this.position=new rect(x,y,window_width,window_height,"left","top");this.resize();this.add_buttons();this.on("keys",data=>{if(data.kb.just_stopped("h")||data.kb.just_stopped("H")){this.show_help()}});this.add_bg_gradient(0,"rgba(0,0,0,0.3)");this.add_bg_gradient(.7,"rgba(211,211,211,0.2)");this.add_bg_gradient(.8,"rgba(169,169,169,0.2)");this.add_bg_gradient(1,"rgba(0,0,0,0.3)");this.create_menu_buttons()}render(){if(this.active===false)return;if(!this.graphics||!this.graphics.ctx)return;if(!this.sprites)return;if(!this.render_position||!this.internal_rect||!this.render_internal_rect)return;const ctx=this.graphics.ctx;if(!ctx||typeof ctx.save!=="function")return;if(this.skin){this.sprites.slice_9("window",this.render_position)}ctx.save();ctx.beginPath();ctx.rect(this.render_internal_rect.x,this.render_internal_rect.y,this.render_internal_rect.width,this.render_internal_rect.height);ctx.clip();if(this.external_render_callback!=null){this.external_render_callback(this.render_internal_rect)}if(this.buttons){this.buttons.forEach(button=>button.render())}if(this.ui_components){this.ui_components.forEach(component=>component.render())}if(this.text){this.graphics.font.draw_text(this.render_internal_rect,this.text,true,true)}ctx.restore();if(this.images){for(let i=0;i<this.images.length;i++){let image=this.images[i];if(image===this.title_image){this.render_title_with_glow(image)}else{let image_pos=image.position.clone();this.graphics.sprites.render(image.key,null,image_pos,1,"contain")}}}if(this.skin&&this.sprites&&this.graphics.font){this.sprites.slice_3("window-title",this.render_title_position);this.graphics.font.draw_text(this.render_title_position,this.title,true,false)}if(this.closeButton!=null&&typeof this.closeButton.render==="function"){this.closeButton.render()}}render_title_with_glow(image){if(!this.graphics||!this.graphics.ctx)return;const ctx=this.graphics.ctx;this.glow_phase+=.05;const pulse=25+Math.sin(this.glow_phase)*15;ctx.save();ctx.shadowColor="rgba(0, 255, 255, 0.8)";ctx.shadowBlur=pulse*2;let image_pos=image.position.clone();this.graphics.sprites.render(image.key,null,image_pos,1,"contain");ctx.shadowColor="rgba(0, 230, 255, 0.6)";ctx.shadowBlur=pulse*1.5;image_pos=image.position.clone();this.graphics.sprites.render(image.key,null,image_pos,1,"contain");ctx.shadowColor="rgba(0, 200, 255, 0.4)";ctx.shadowBlur=pulse;image_pos=image.position.clone();this.graphics.sprites.render(image.key,null,image_pos,1,"contain");ctx.shadowColor="transparent";ctx.shadowBlur=0;ctx.shadowOffsetX=0;ctx.shadowOffsetY=0;image_pos=image.position.clone();this.graphics.sprites.render(image.key,null,image_pos,1,"contain");ctx.restore();ctx.shadowColor="transparent";ctx.shadowBlur=0;ctx.shadowOffsetX=0;ctx.shadowOffsetY=0}show_help(){let modal=new help;this.window_manager.add(modal)}create_menu_buttons(){this.menu_buttons=[];let x=20;let y=30;let button_spacing=80;let button_width=this.internal_rect.width-x*2;let vw=this.graphics.viewport.virtual.width;this.menu_buttons=[{label:"New Game",callback:this.new_game,y_offset:y,style:"cyan"},{label:"Prologue",callback:this.story,y_offset:y+button_spacing,style:"cyan"},{label:"High Scores",callback:this.high_scoress,y_offset:y+button_spacing*2,style:"cyan"},{label:"Credits",callback:this.credits,y_offset:y+button_spacing*3,style:"cyan"},{label:"Exit",callback:this.exit,y_offset:this.internal_rect.height-110,style:"red"}];for(let btn_def of this.menu_buttons){let button_position=new rect(x,btn_def.y_offset,button_width,null,"left","top");let up_img=btn_def.style==="cyan"?"button-up-cyan":"button-up-red";let down_img=btn_def.style==="cyan"?"button-down-cyan":"button-down-red";btn_def.button=this.add_button(btn_def.label,button_position,btn_def.callback,up_img,down_img);btn_def.position=button_position}let title_width=Math.min(1024,vw*.6);let title_height=title_width*(236/1024);let title_x=vw/2-title_width/2;let button_position6=new rect(title_x,10,title_width,title_height,"left","top");this.title_image=this.add_image(button_position6,"title")}resize(){if(this.graphics&&this.graphics.viewport){let vw=this.graphics.viewport.virtual.width;let vh=this.graphics.viewport.virtual.height;let window_width=400;let window_height=600;let x=60;let y=(vh-window_height)/2;this.position.x=x;this.position.y=y;this.position.width=window_width;this.position.height=window_height}super.resize();if(this.title_image&&this.graphics&&this.graphics.viewport){let vw=this.graphics.viewport.virtual.width;let title_x=vw/2-512;this.title_image.position.x=title_x}}exit(event){alert("I can't realy close the window...\n But I'd like to!\n Thanks for playin\n -Chris")}async credits(event){if(this.audio_manager&&this.audio_manager.audioContext.state==="suspended"){await this.audio_manager.audioContext.resume()}let modal=new credits;this.window_manager.add(modal)}high_scoress(event){let modal=new high_scores;this.window_manager.add(modal)}async story(event){if(this.audio_manager&&this.audio_manager.audioContext.state==="suspended"){await this.audio_manager.audioContext.resume()}let modal=new prologue;this.window_manager.add(modal)}new_game(){let modal=new game;this.window_manager.add(modal)}}class motion{constructor(x,y,width,height,mass,rotation){this.mass=mass;this.damping_factor=.1;this.velocity_loss=1;this.rotation=rotation;this.position=new rect(x,y,width,height);this.acceleration=new point(0,0);this.velocity=new point(0,0);this.IMMOVABLE_MASS=1e4;this.bounce_factor=1.2;this.old_state={}}save_state(){this.old_state["mass"]=this.mass;this.old_state["damping_factor"]=this.damping_factor;this.old_state["velocity_loss"]=this.velocity_loss;this.old_state["rotation"]=this.rotation;this.old_state["position"]=this.position;this.old_state["acceleration"]=this.acceleration;this.old_state["velocity"]=this.velocity;this.old_state["IMMOVABLE_MASS"]=this.IMMOVABLE_MASS;this.old_state["bounce_factor"]=this.bounce_factor}restore_state(){this.mass=this.old_state["mass"];this.damping_factor=this.old_state["damping_factor"];this.velocity_loss=this.old_state["velocity_loss"];this.rotation=this.old_state["rotation"];this.position=this.old_state["position"];this.acceleration=this.old_state["acceleration"];this.velocity=this.old_state["velocity"];this.IMMOVABLE_MASS=this.old_state["IMMOVABLE_MASS"];this.bounce_factor=this.old_state["bounce_factor"]}update_position(delta_time){this.position.x+=this.velocity.x*delta_time;this.position.y+=this.velocity.y*delta_time}update_accelleration(delta_time){this.acceleration.x-=this.acceleration.x*this.damping_factor;this.acceleration.y-=this.acceleration.y*this.damping_factor}update_velocity(delta_time){this.velocity.x+=this.acceleration.x*delta_time;this.velocity.y+=this.acceleration.y*delta_time;if(this.velocity_loss!=1){if(this.velocity.x!=0){this.velocity.x*=this.velocity_loss}if(this.velocity.y!=0){this.velocity.y*=this.velocity_loss}}}update_motion(delta_time){if(delta_time!=0){this.save_state();this.update_accelleration(delta_time);this.update_velocity(delta_time);this.update_position(delta_time)}}async accelerate_object(direction,speed){direction%=360;var rotationInRadians=direction*Math.PI/180;var ax=Math.sin(rotationInRadians)*speed/this.mass;var ay=-Math.cos(rotationInRadians)*speed/this.mass;this.acceleration.x+=ax;this.acceleration.y+=ay}get_combine_center(otherObject){let thisCenterX=this.position.x+this.width/2;let thisCenterY=this.position.y+this.height/2;let otherCenterX=otherObject.position.x+otherObject.width/2;let otherCenterY=otherObject.position.y+otherObject.height/2;let combinedCenterX=(thisCenterX+otherCenterX)/2;let combinedCenterY=(thisCenterY+otherCenterY)/2;return{x:combinedCenterX,y:combinedCenterY}}collision_distance(otherObject){let thisCenterX=this.position.x+this.width/2;let thisCenterY=this.position.y+this.height/2;let otherCenterX=otherObject.position.x+otherObject.width/2;let otherCenterY=otherObject.position.y+otherObject.height/2;let distanceX=Math.abs(thisCenterX-otherCenterX);let distanceY=Math.abs(thisCenterY-otherCenterY);let combinedWidth=(this.width+otherObject.width)/2;let combinedHeight=(this.height+otherObject.height)/2;if(distanceX<combinedWidth&&distanceY<combinedHeight){return{x:combinedWidth-distanceX,y:combinedHeight-distanceY}}return false}check_collision(otherObject){if(!this.width||!this.height||!otherObject.width||!otherObject.height){console.error("[Collision] Missing dimensions:",{this:{type:this.type,w:this.width,h:this.height},other:{type:otherObject.type,w:otherObject.width,h:otherObject.height}});return false}const thisBounds=this.mask_bounds||{x:0,y:0,width:this.width,height:this.height};const otherBounds=otherObject.mask_bounds||{x:0,y:0,width:otherObject.width,height:otherObject.height};const thisLeft=this.position.x+thisBounds.x;const thisRight=thisLeft+thisBounds.width;const thisTop=this.position.y+thisBounds.y;const thisBottom=thisTop+thisBounds.height;const otherLeft=otherObject.position.x+otherBounds.x;const otherRight=otherLeft+otherBounds.width;const otherTop=otherObject.position.y+otherBounds.y;const otherBottom=otherTop+otherBounds.height;if(thisRight<otherLeft||thisLeft>otherRight||thisBottom<otherTop||thisTop>otherBottom){return false}if(Math.random()<.01){console.log("[Collision] AABB passed:",{this:this.type,other:otherObject.type,hasMasks:!!(this.collision_mask&&otherObject.collision_mask)})}if(this.collision_mask&&otherObject.collision_mask){return this.check_pixel_collision(otherObject)}let thisCenterX=this.position.x+this.width/2;let thisCenterY=this.position.y+this.height/2;let otherCenterX=otherObject.position.x+otherObject.width/2;let otherCenterY=otherObject.position.y+otherObject.height/2;let dx=thisCenterX-otherCenterX;let dy=thisCenterY-otherCenterY;let distance=Math.sqrt(dx*dx+dy*dy);let thisRadius=Math.min(this.width,this.height)*.7;let otherRadius=Math.min(otherObject.width,otherObject.height)*.7;let combinedRadius=thisRadius+otherRadius;const isColliding=distance<combinedRadius;if(isColliding&&Math.random()<.05){console.log("[Collision] CIRCULAR HIT!",{this:this.type,other:otherObject.type,distance:distance.toFixed(2),combinedRadius:combinedRadius.toFixed(2)})}return isColliding}check_pixel_collision(otherObject){const overlapLeft=Math.max(this.position.x,otherObject.position.x);const overlapRight=Math.min(this.position.x+this.width,otherObject.position.x+otherObject.width);const overlapTop=Math.max(this.position.y,otherObject.position.y);const overlapBottom=Math.min(this.position.y+this.height,otherObject.position.y+otherObject.height);const smallestDimension=Math.min(Math.min(this.width,this.height),Math.min(otherObject.width,otherObject.height));const step=smallestDimension<=32?2:4;for(let y=overlapTop;y<overlapBottom;y+=step){for(let x=overlapLeft;x<overlapRight;x+=step){const thisX=Math.floor(x-this.position.x);const thisY=Math.floor(y-this.position.y);const otherX=Math.floor(x-otherObject.position.x);const otherY=Math.floor(y-otherObject.position.y);if(thisX>=0&&thisX<this.width&&thisY>=0&&thisY<this.height&&otherX>=0&&otherX<otherObject.width&&otherY>=0&&otherY<otherObject.height){const thisIndex=thisY*this.width+thisX;const otherIndex=otherY*otherObject.width+otherX;if(this.collision_mask[thisIndex]&&otherObject.collision_mask[otherIndex]){return true}}}}return false}impact2(otherObject){let v1=this.velocity;let v2=otherObject.velocity;let m1=this.mass;let m2=otherObject.mass;let immovable1=this.mass==1e4;let immovable2=otherObject.mass==1e4;if(!immovable1){let final_v1x=immovable2?v1.x:(v1.x*(m1-m2)+2*m2*v2.x)/(m1+m2);let final_v1y=immovable2?v1.y:(v1.y*(m1-m2)+2*m2*v2.y)/(m1+m2);this.velocity.x=final_v1x;this.velocity.y=final_v1y}if(!immovable2){let final_v2x=immovable1?v2.x:(v2.x*(m2-m1)+2*m1*v1.x)/(m1+m2);let final_v2y=immovable1?v2.y:(v2.y*(m2-m1)+2*m1*v1.y)/(m1+m2);otherObject.velocity.x=final_v2x;otherObject.velocity.y=final_v2y}}impact(otherObject){let v1=this.velocity;let v2=otherObject.velocity;let m1=this.mass;let m2=otherObject.mass;if(this.mass!=1e4){let final_v1x=(v1.x*(m1-m2)+2*m2*v2.x)/(m1+m2);let final_v1y=(v1.y*(m1-m2)+2*m2*v2.y)/(m1+m2);this.velocity.x=final_v1x;this.velocity.y=final_v1y}if(otherObject.mass!=1e4){let final_v2x=(v2.x*(m2-m1)+2*m1*v1.x)/(m1+m2);let final_v2y=(v2.y*(m2-m1)+2*m1*v1.y)/(m1+m2);otherObject.velocity.x=final_v2x;otherObject.velocity.y=final_v2y}}adjustAccelerationDirection(object,collisionAngle,away=true){let accelerationMagnitude=Math.sqrt(object.acceleration.x**2+object.acceleration.y**2);let newDirectionAngle=away?collisionAngle+Math.PI:collisionAngle;object.acceleration.x=Math.cos(newDirectionAngle)*accelerationMagnitude;object.acceleration.y=Math.sin(newDirectionAngle)*accelerationMagnitude}}class game_object extends motion{static uuid_generator=function*(){const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let counter=0;while(true){let id="";let currentCounter=counter;if(currentCounter>=Math.pow(chars.length,4)){throw new Error("ID space exhausted")}for(let i=0;i<4;i++){id=chars[currentCounter%chars.length]+id;currentCounter=Math.floor(currentCounter/chars.length)}yield id;counter++}}();constructor(window_manager,x=0,y=0,width=64,height=64,mass=100,rotation=0,rotation_speed=4){super(x,y,width,height,mass,rotation);this.window_manager=window_manager;this.audio_manager=window_manager.audio_manager;this.graphics=window_manager.graphics;this.type="block";this.sounds={};this.width=width;this.height=height;this.rotation_speed=rotation_speed;this.img=null;this.image_frame=0;this.image_frames=1;this.image_rotation=0;this.anchor_points=[];this.top_level=true;this.created=Date.now();this.expires=null;this.action_list=null;this.action_position={frame:0,row:0};this.destroy_object=false;this.loop_done=false;this.loop=true;this.center={x:0,y:0};this.life=100;this.max_life=100;this.visible=true;this.explosions=[];this.old_acceleration=null;this.old_velocity=null;this.old_position=null;this.collision_mask=null;this.mask_bounds=null;this.id=game_object.uuid_generator.next().value}set_rotation_speed(speed){this.rotation_speed=speed}set_rotation(rotation){this.rotation=rotation}play(sound_name,single=false){sound_name=this.type+sound_name;if(sound_name in this.sounds){if(single==true&&this.audio_manager.is_playing(sound_name))return;this.audio_manager.play(sound_name)}}set_loop(loop){this.loop=loop}set_visible(visible){this.visible=visible}loop_complete(){return this.loop_done}damage(damage){if(this.destroy_object)return;this.life-=damage;if(this.life<=0){this.life=0;this.destroy()}}set_max_life(max_life){this.max_life=max_life;this.life=max_life}get_life_percentage(){if(this.life<0)return 0;if(this.life>this.max_life)return 100;return parseInt(this.life/this.max_life*100)}destroy(){if(this.destroy_object)return;this.destroy_object=true}set_type(type){this.type=type}set_velocity(velocity){this.velocity.x=velocity.x;this.velocity.y=velocity.y}set_dimensions(width,height){this.width=width;this.height=height}expire(seconds){this.expires=seconds}set_center(x,y){this.center.x=x;this.center.y=y}set_sub(){this.top_level=false}get_anchor_point(indeX){}set_velocity_loss(loss){this.velocity_loss=loss}set_velocity_loss_off(loss){this.velocity_loss=1}set_image(img_URL,frame_width=1,frames=1,rotation=0){this.image_rotation=rotation;this.image_frames=frames;this.frame_width=frame_width;this.img=img_URL;this.graphics.sprites.add(img_URL);this.get_collision_mask()}get_collision_mask(){setTimeout(()=>{try{const position=new rect(0,0,this.width,this.height);const maskData=this.graphics.sprites.get_or_create_collision_mask(this.img,position);if(!maskData)return;this.collision_mask=maskData.collision_mask;this.mask_bounds=maskData.mask_bounds}catch(error){console.error(`[${this.type}] Failed to get collision mask:`,error)}},100)}image_rotate(rotation){this.image_rotation=rotation}set_sound(action,sound_URL){this.sounds[this.type+action]=sound_URL;this.audio_manager.add(this.type+action,sound_URL).catch(err=>{console.error(`Failed to load sound ${sound_URL}:`,err)})}async bank_left(){this.rotation-=this.rotation_speed;if(this.rotation<0)this.rotation+=360;this.play("bank_left",true)}async bank_right(){this.rotation+=this.rotation_speed;this.rotation%=360;this.play("bank_right",true)}async accelerate(speed=null){this.play("accel",true);speed=speed??10;this.accelerate_object(this.rotation,speed)}async decelerate(speed=null){this.play("decel",true);speed=speed??10;this.accelerate_object(this.rotation+180,speed)}async strafe_left(speed=null){speed=speed??10;this.accelerate_object(this.rotation+270,speed);this.play("bank_left",true)}async strafe_right(speed=null){speed=speed??10;this.play("bank_right",true);this.accelerate_object(this.rotation+90,speed)}async rotate(rotation){this.rotation=rotation}restore_last_position(){this.acceleration=this.old_acceleration;this.velocity=this.old_velocity;this.position=this.old_position}update_frame(deltaTime){this.update_motion(deltaTime);if(this.visible==false)return;if(this.image_frames>1){if(this.loop==false&&this.image_frame>=this.image_frames-1){this.loop_done=true}this.image_frame++;this.image_frame%=this.image_frames}for(let b=0;b<this.explosions.length;b++){this.explosions[b].update_frame(deltaTime);if(this.explosions[b].loop_complete()){this.explosions.splice(b,1)}}this.playActions()}orient(window=null){if(!this.graphics||!this.graphics.ctx||typeof this.graphics.ctx.save!=="function")return;this.graphics.ctx.save();let x=this.position.x;let y=this.position.y;if(window!=null){x-=window.x;y-=window.y}this.graphics.ctx.translate(x,y);var radians=(this.rotation+this.image_rotation)%360*Math.PI/180;this.graphics.ctx.rotate(radians)}de_orient(){this.graphics.ctx.restore()}rotatePoint(x,y,cx,cy,rotation){let translatedX=x-cx;let translatedY=y-cy;let radians=rotation*Math.PI/180;let cosTheta=Math.cos(radians);let sinTheta=Math.sin(radians);let rotatedX=translatedX*cosTheta-translatedY*sinTheta;let rotatedY=translatedX*sinTheta+translatedY*cosTheta;rotatedX+=cx;rotatedY+=cy;return{x:rotatedX,y:rotatedY}}get_relative_position(x,y){return this.rotatePoint(x,y,0,0,this.rotation)}render(){if(this.visible==false)return;let sourceX=0;let sourceY=0;let sourceWidth=this.width;let sourceHeight=this.height;if(this.image_frames>1){sourceX=this.image_frame*this.frame_width;sourceWidth=this.frame_width}let src=new rect(sourceX,sourceY,sourceWidth,sourceHeight);let dest=new rect(-this.center.x,-this.center.y,sourceWidth,sourceHeight);this.graphics.sprites.render(this.img,src,dest,1,"none");for(let i=0;i<this.explosions.length;i++){this.explosions[i].render()}}renderWithOverlay(overlayColor){if(this.image_frames>1){let sourceX=this.image_frame*this.frame_width;let sourceY=0;let sourceWidth=this.frame_width;let sourceHeight=this.height;if(!this.graphics||!this.graphics.ctx||typeof this.graphics.ctx.save!=="function")return;this.graphics.ctx.save();this.graphics.ctx.beginPath();this.graphics.ctx.rect(-this.center.x,-this.center.y,sourceWidth,sourceHeight);this.graphics.ctx.clip();this.graphics.ctx.drawImage(this.img,sourceX,sourceY,sourceWidth,sourceHeight,-this.center.x,-this.center.y,sourceWidth,sourceHeight);this.graphics.ctx.globalCompositeOperation="source-atop";this.graphics.ctx.fillStyle=overlayColor;this.graphics.ctx.fillRect(-this.center.x,-this.center.y,sourceWidth,sourceHeight);this.graphics.ctx.restore()}else{if(!this.graphics||!this.graphics.ctx||typeof this.graphics.ctx.save!=="function")return;this.graphics.ctx.save();this.graphics.ctx.beginPath();this.graphics.ctx.rect(-this.center.x,-this.center.y,this.width,this.height);this.graphics.ctx.clip();this.graphics.ctx.drawImage(this.img,-this.center.x,-this.center.y);this.graphics.ctx.globalCompositeOperation="source-atop";this.graphics.ctx.fillStyle=overlayColor;this.graphics.ctx.fillRect(-this.center.x,-this.center.y,this.width,this.height);this.graphics.ctx.restore()}}async playActions(){if(this.action_list==null)return;let action=this.action_list[this.action_position.row];this.executeAction(action);this.action_position.frame++;if(this.action_position.frame>=action.frames){this.action_position.row++;this.action_position.frame=0;if(this.action_position.row>=this.action_list.length){this.action_position.row=0}}}async executeAction(action){switch(action.type){case"bank_left":await this.bank_left();break;case"bank_right":await this.bank_right();break;case"accelerate":await this.accelerate(action.speed);break;case"decelerate":await this.decelerate(action.speed);break;case"rotate":await this.rotate(action.rotation);break;case"strafe_left":await this.strafe_left(action.speed);break;case"strafe_right":await this.strafe_right(action.speed);break;case"skip":break}}async wait(frames){return new Promise(resolve=>setTimeout(resolve,frames*millisecondsPerFrame))}explosion(){let exp=new Explosion(this.window_manager,0,0,this.play_sounds,this.volume);this.explosions.push(exp)}}class Explosion extends game_object{constructor(window_manager,x,y){super(window_manager,x,y,128,128,0,0,10);this.set_image("static/explosion/exp_9_128x128_35frames_strip35.png",128,35);this.set_center(64,64);this.set_type("explosion");this.set_loop(false)}}class Derbis extends game_object{constructor(window_manager,x,y,type){let speed=.5+Math.random()*1;let default_action=[{type:"bank_left",frames:3},{type:"accelerate",frames:3},{type:"bank_right",frames:3},{type:"accelerate",frames:3},{type:"decelerate",frames:3},{type:"bank_left",frames:6},{type:"decelerate",frames:3},{type:"bank_left",frames:3},{type:"skip",frames:4}];switch(type){case"email":super(window_manager,x,y,64,64,2,0,10);this.set_image("static/debris/email.png");this.set_type("email");this.set_max_life(50);let email_action=[{frames:4,type:"strafe_left",speed:speed},{frames:15,type:"skip"},{frames:4,type:"strafe_right",speed:speed},{frames:15,type:"skip"}];this.action_list=email_action;break;case"pdf":super(window_manager,x,y,64,64,1,0,4);this.set_image("static/debris/pdf.png");this.set_type("pdf");this.set_max_life(30);let pdf_action=[{type:"accelerate",frames:1},{type:"accelerate",frames:1},{type:"accelerate",frames:1},{type:"accelerate",frames:1},{type:"bank_left",frames:4}];this.action_list=pdf_action;break;case"call":super(window_manager,x,y,64,64,2,0,4);this.set_image("static/debris/phone.png");this.set_type("call");this.set_max_life(40);let call_action=[{type:"bank_right",frames:1}];this.action_list=call_action;break;case"webex":super(window_manager,x,y,64,64,2,0,4);this.set_image("static/debris/webex2.png");this.set_type("webex");this.set_max_life(40);this.action_list=default_action;break;case"block":super(window_manager,x,y,64,64,1e4,0,0);this.set_image("static/blocks/block.png");this.set_type("block");break;case"linkedin":super(window_manager,x,y,64,64,3,0,6);this.set_image("static/ships/linkedin.png");this.set_type("linkedin");this.set_max_life(60);let linkedin_action=[{type:"bank_left",frames:2},{type:"accelerate",frames:3,speed:speed},{type:"bank_right",frames:2},{type:"skip",frames:5}];this.action_list=linkedin_action;break;case"zoom":super(window_manager,x,y,64,64,2,0,8);this.set_image("static/debris/webex2.png");this.set_type("zoom");this.set_max_life(45);let zoom_action=[{frames:3,type:"strafe_right",speed:speed},{frames:10,type:"skip"},{frames:3,type:"strafe_left",speed:speed},{frames:10,type:"skip"}];this.action_list=zoom_action;break;case"facebook":super(window_manager,x,y,64,64,3,0,5);this.set_image("static/debris/email.png");this.set_type("facebook");this.set_max_life(55);let facebook_action=[{type:"bank_right",frames:3},{type:"accelerate",frames:2,speed:speed},{type:"skip",frames:8}];this.action_list=facebook_action;break;case"reddit":super(window_manager,x,y,64,64,2,0,7);this.set_image("static/debris/pdf.png");this.set_type("reddit");this.set_max_life(40);let reddit_action=[{type:"bank_left",frames:1},{type:"bank_right",frames:1},{type:"skip",frames:3}];this.action_list=reddit_action;break}this.rotation=180}}class Projectile extends game_object{constructor(window_manager,x,y,rotation,type,sounds=false){let actions=[];switch(type){case"lazer":actions=[{type:"accelerate",frames:1}];super(window_manager,x,y,16,16,.5,rotation,4);this.set_image("static/projectiles/P3.png",16,4,270);this.set_velocity_loss_off();this.set_center(8,8);this.expire(5);this.set_type("laser");this.action_list=actions;break;case"bolt1":super(window_manager,x,y,16,16,.6,rotation,4);this.set_image("static/projectiles/P1.png",16,4,270);this.center.x=8;this.set_velocity_loss_off();this.expire(5);this.set_type("bolt");actions=[{type:"accelerate",frames:1,speed:5}];this.action_list=actions;break;case"bolt2":super(window_manager,x,y,16,16,.6,rotation,4);this.set_image("static/projectiles/P2.png",16,4,270);this.center.x=8;this.set_velocity_loss_off();this.expire(5);this.set_type("bolt");actions=[{type:"accelerate",frames:1,speed:5}];this.action_list=actions;break;case"bolt3":super(window_manager,x,y,16,16,.5,rotation,4);this.set_image("static/projectiles/P3.png",16,4,270);this.center.x=8;this.set_velocity_loss_off();this.expire(5);this.set_type("bolt");actions=[{type:"accelerate",frames:1,speed:50}];this.action_list=actions;break;case"bolt4":super(window_manager,x,y,16,16,1,rotation,4);this.set_image("static/projectiles/P4.png",16,4,270);this.center.x=8;this.set_velocity_loss_off();this.expire(5);this.set_type("bolt");actions=[{type:"accelerate",frames:1,speed:10}];this.action_list=actions;break;case"thruster":super(window_manager,x,y,16,16,400,rotation,4);this.set_image("static/ships/Water Bolt.png",16,5,270);this.set_velocity_loss_off();this.center.x=8;this.center.y=8;this.expire(5);this.set_type("thrusters");break;case"booster":super(window_manager,x,y,32,64,400,rotation,4);this.set_image("static/ships/booster.png",32,4,0);this.set_velocity_loss_off();this.center.x=16;this.center.y=2;this.set_type("booster");break}}}class HeatSeekingMissile extends game_object{constructor(window_manager,x=0,y=0,rotation=0){super(window_manager,x,y,32,32,100,rotation,8);this.target=null;this.maxSpeed=300;this.turningRate=5;this.accelerationRate=50;this.set_image("static/projectiles/P4.png",16,4,270);this.set_center(16,16);this.set_velocity_loss_off();this.set_type("missile");this.expire(10);this.set_max_life(1)}set_target(target){this.target=target}find_nearest_target(npcs){if(!npcs||npcs.length===0)return null;let nearest=null;let nearestDist=Infinity;for(let npc of npcs){if(npc.destroy_object)continue;if(npc.type!=="ship"&&npc.type!=="email"&&npc.type!=="pdf")continue;const dx=npc.position.x-this.position.x;const dy=npc.position.y-this.position.y;const dist=Math.sqrt(dx*dx+dy*dy);if(dist<nearestDist){nearestDist=dist;nearest=npc}}return nearest}update_frame(deltaTime){if(this.target&&this.target.destroy_object){this.target=null}if(this.target){this.rotateTowardsTarget();this.accelerate_towards_target()}this.limitSpeed();super.update_frame(deltaTime)}rotateTowardsTarget(){if(!this.target)return;const deltaX=this.target.position.x-this.position.x;const deltaY=this.target.position.y-this.position.y;const targetAngle=(Math.atan2(deltaX,-deltaY)*(180/Math.PI)+360)%360;let angleDiff=targetAngle-this.rotation;if(angleDiff>180)angleDiff-=360;if(angleDiff<-180)angleDiff+=360;if(Math.abs(angleDiff)>this.turningRate){if(angleDiff>0){this.bank_right()}else{this.bank_left()}}else{this.rotation=targetAngle}}accelerate_towards_target(){this.accelerate_object(this.rotation,this.accelerationRate)}limitSpeed(){const speed=Math.sqrt(Math.pow(this.velocity.x,2)+Math.pow(this.velocity.y,2));if(speed>this.maxSpeed){const scaleFactor=this.maxSpeed/speed;this.velocity.x*=scaleFactor;this.velocity.y*=scaleFactor}}}class Ship extends game_object{constructor(window_manager,x,y,type){super(window_manager,x,y,128,153,10,0,8);this.boost_fire_control=new fire_control(1);this.laser_fire_control=new fire_control(5);this.missile_fire_control=new fire_control(10);this.shield_fire_control=new fire_control(3,2e3,2e3);this.thrusters=[];this.projectiles=[];this.booster=null;this.bolt_type=null;this.missile_type=null;this.shield_strength=100;this.shield_max_strength=100;this.shield_regen_rate=1;this.shield_impacts=[];this.shield_glow_phase=0;let speed=5+.5+Math.random()*4;switch(type){case"user":this.set_type("ship");this.set_sound("left","static/audio/ship/static.mp3");this.set_sound("right","static/audio/ship/static.mp3");this.set_sound("accel","static/audio/ship/static.mp3");this.set_sound("decel","static/audio/ship/static.mp3");this.set_sound("lazer","static/audio/projectiles/sfx_wpn_laser6.wav");this.set_sound("missile","static/audio/projectiles/sfx_weapon_singleshot13.wav");this.set_image("static/ships/ship1.png");this.set_center(64,64);this.booster=new Projectile(window_manager,+0,100,0,"booster");this.thrusters.push(this.booster);var thruster1=new Projectile(window_manager,+30,75,0,"thruster");this.thrusters.push(thruster1);var thruster2=new Projectile(window_manager,-30,75,0,"thruster");this.thrusters.push(thruster2);this.bolt_type="bolt3";this.missile_type="bolt4";break;case"teams":this.set_type("ship");this.set_image("static/ships/teams.png",64,1,270);this.set_rotation(270);this.set_center(64,64);this.set_rotation_speed(10);this.set_max_life(100);this.bolt_type="bolt2";this.missile_type="bolt3";let frames=Math.random()*15+10;let actions=[{type:"bank_right",frames:9},{type:"accelerate",frames:frames,speed:speed},{type:"lazer",frames:1,speed:5},{type:"bank_left",frames:15},{type:"accelerate",frames:6,speed:5},{type:"skip",frames:4}];this.action_list=actions;this.action_position.frame=parseInt(Math.random()*actions.length);break}}set_volume(volume){super.set_volume(volume);for(let thruster of this.thrusters){thruster.volume=volume}for(let projectile of this.projectiles){projectile.volume=volume}}boost(){if(!this.boost_fire_control.overheated){this.booster.set_visible(true);this.accelerate(200);this.boost_fire_control.temprature+=.5;if(this.boost_fire_control.temprature>this.boost_fire_control.max_tempreture){this.boost_fire_control.temprature=this.boost_fire_control.max_tempreture;this.boost_fire_control.overheated=true;this.boost_fire_control.overheated_cooldown_start=0}this.boost_fire_control.is_firing=true}else{this.booster.set_visible(false)}}stop_boost(){this.boost_fire_control.stop_firing();this.booster.set_visible(false)}get_shield_percentage(){return this.shield_strength/this.shield_max_strength*100}damage(amount,impactX=0,impactY=0){const maxDeflection=.8;const shieldPercentage=this.shield_strength/this.shield_max_strength;const deflectionPercentage=shieldPercentage*maxDeflection;const damageDeflected=amount*deflectionPercentage;const damageTaken=amount-damageDeflected;const shieldDecay=amount*.15;this.shield_strength-=shieldDecay;if(this.shield_strength<0)this.shield_strength=0;if(shieldPercentage>0){const rotRad=this.rotation%360*Math.PI/180;const cos=Math.cos(-rotRad);const sin=Math.sin(-rotRad);const localX=impactX*cos-impactY*sin;const localY=impactX*sin+impactY*cos;this.shield_impacts.push({x:localX,y:localY,time:Date.now(),intensity:Math.min(deflectionPercentage,1)})}super.damage(damageTaken);console.log(`[Ship] Shields at ${(shieldPercentage*100).toFixed(1)}% deflected ${deflectionPercentage.toFixed(1)}% (${damageDeflected.toFixed(1)} dmg), took ${damageTaken.toFixed(1)} damage`)}fire_lazer(){if(this.laser_fire_control.can_fire()){let lazer1=this.get_relative_position(-60,-35);var projectile=new Projectile(this.window_manager,this.position.x+lazer1.x,this.position.y+lazer1.y,this.rotation,this.bolt_type);projectile.set_velocity(this.velocity);projectile.accelerate(50);this.projectiles.push(projectile);let lazer2=this.get_relative_position(+60,-35);var projectile=new Projectile(this.window_manager,this.position.x+lazer2.x,this.position.y+lazer2.y,this.rotation,this.bolt_type);projectile.set_velocity(this.velocity);projectile.accelerate(50);this.projectiles.push(projectile);this.play("lazer")}}stop_firing_lazer(){this.laser_fire_control.stop_firing()}fire_missle(npcs){if(this.missile_fire_control.can_fire()){let missle1=this.get_relative_position(0,-80);var missile=new HeatSeekingMissile(this.window_manager,this.position.x+missle1.x,this.position.y+missle1.y,this.rotation);missile.set_velocity(this.velocity);missile.accelerate(30);if(npcs&&npcs.length>0){const target=missile.find_nearest_target(npcs);if(target){missile.set_target(target)}}this.projectiles.push(missile);this.missile_fire_control.stop_firing();this.play("missile")}}update_frame(deltaTime){super.update_frame(deltaTime);this.laser_fire_control.update_frame();this.missile_fire_control.update_frame();this.boost_fire_control.update_frame();if(this.shield_strength<this.shield_max_strength){this.shield_strength+=this.shield_regen_rate;if(this.shield_strength>this.shield_max_strength){this.shield_strength=this.shield_max_strength}}if(this.life<this.max_life){this.life+=1*deltaTime*60;if(this.life>this.max_life){this.life=this.max_life}}this.shield_glow_phase+=deltaTime*3;const currentTime=Date.now();this.shield_impacts=this.shield_impacts.filter(impact=>currentTime-impact.time<1e3);if(this.type==="ship"&&this.bolt_type==="bolt3"){const viewport=this.graphics.viewport.virtual;const margin=this.width/2;if(this.position.x<margin){this.position.x=margin;this.velocity.x=0}if(this.position.x>viewport.width-margin){this.position.x=viewport.width-margin;this.velocity.x=0}const worldY=this.position.y-this.graphics.viewport.world.y;const minY=margin;const maxY=viewport.height-margin;if(worldY<minY){this.position.y=this.graphics.viewport.world.y+minY;this.velocity.y=Math.max(0,this.velocity.y)}if(worldY>maxY){this.position.y=this.graphics.viewport.world.y+maxY;this.velocity.y=Math.min(0,this.velocity.y)}}const timestamp=Date.now();for(let i=this.projectiles.length-1;i>=0;i--){const projectile=this.projectiles[i];if(timestamp-projectile.created>5e3){this.projectiles.splice(i,1)}else{projectile.update_frame(deltaTime)}}for(let thruster of this.thrusters){thruster.update_frame(deltaTime)}}render(window){super.orient(window);if(this.shield_impacts.length>0){this.render_shield()}for(let thruster of this.thrusters){thruster.orient();thruster.render();thruster.de_orient()}super.render();super.de_orient();for(let projectile of this.projectiles){projectile.orient(window);projectile.render();projectile.de_orient()}}render_shield(){if(!this.graphics||!this.graphics.ctx)return;const ctx=this.graphics.ctx;if(!ctx||typeof ctx.save!=="function")return;ctx.save();const shieldAlpha=this.shield_strength/this.shield_max_strength;const shieldRadius=80;const currentTime=Date.now();for(let impact of this.shield_impacts){const age=currentTime-impact.time;const lifetime=800;const progress=age/lifetime;const impactAlpha=(1-progress)*impact.intensity*shieldAlpha;const pulsePhase=(1-progress)*Math.PI*4;const pulse=.7+Math.sin(pulsePhase)*.3;const distance=Math.sqrt(impact.x*impact.x+impact.y*impact.y)||1;const dirX=impact.x/distance;const dirY=impact.y/distance;const impactX=dirX*shieldRadius;const impactY=dirY*shieldRadius;const arcSize=60+progress*40;const arcAngle=arcSize*Math.PI/180;const impactAngle=Math.atan2(dirY,dirX);for(let layer=0;layer<3;layer++){const layerRadius=shieldRadius+layer*15;const layerAlpha=impactAlpha*(1-layer*.3)*pulse;const gradient=ctx.createRadialGradient(0,0,shieldRadius-5,0,0,layerRadius);gradient.addColorStop(0,`rgba(100, 150, 255, 0)`);gradient.addColorStop(.8,`rgba(80, 180, 255, ${layerAlpha*.7})`);gradient.addColorStop(1,`rgba(100, 200, 255, ${layerAlpha*.9})`);ctx.fillStyle=gradient;ctx.beginPath();ctx.arc(0,0,layerRadius,impactAngle-arcAngle/2,impactAngle+arcAngle/2);ctx.arc(0,0,shieldRadius-5,impactAngle+arcAngle/2,impactAngle-arcAngle/2,true);ctx.closePath();ctx.fill()}const flashGradient=ctx.createRadialGradient(impactX,impactY,0,impactX,impactY,30);flashGradient.addColorStop(0,`rgba(200, 230, 255, ${impactAlpha*pulse*1})`);flashGradient.addColorStop(.4,`rgba(100, 180, 255, ${impactAlpha*pulse*.8})`);flashGradient.addColorStop(.7,`rgba(80, 150, 255, ${impactAlpha*pulse*.5})`);flashGradient.addColorStop(1,`rgba(60, 120, 255, 0)`);ctx.fillStyle=flashGradient;ctx.beginPath();ctx.arc(impactX,impactY,30,0,Math.PI*2);ctx.fill()}ctx.restore()}async executeAction(action){super.executeAction(action);switch(action.type){case"lazer":this.fire_lazer();break}}destroy(){if(this.bolt_type==="bolt3"){this.create_death_explosion()}super.destroy()}create_death_explosion(){const rings=2;const explosionsPerRing=6;const shipX=this.position.x;const shipY=this.position.y;const level=this.window_manager.modals.find(m=>m.level);if(!level||!level.level){console.error("[Ship] Cannot create death explosion - level not found");return}let centerExp=new Explosion(this.window_manager,shipX,shipY);centerExp.set_sub();level.level.npc.push(centerExp);let currentRing=0;const createRing=()=>{if(currentRing>=rings)return;const radius=30+currentRing*50;for(let i=0;i<explosionsPerRing;i++){const angle=i/explosionsPerRing*Math.PI*2;const offsetX=Math.cos(angle)*radius;const offsetY=Math.sin(angle)*radius;let exp=new Explosion(this.window_manager,shipX+offsetX,shipY+offsetY);exp.set_sub();level.level.npc.push(exp)}for(let i=0;i<2;i++){const randomAngle=Math.random()*Math.PI*2;const randomRadius=Math.random()*radius;const offsetX=Math.cos(randomAngle)*randomRadius;const offsetY=Math.sin(randomAngle)*randomRadius;let exp=new Explosion(this.window_manager,shipX+offsetX,shipY+offsetY);exp.set_sub();level.level.npc.push(exp)}currentRing++;if(currentRing<rings){setTimeout(createRing,100)}};setTimeout(createRing,100)}}class Boss extends game_object{constructor(window_manager,x,y,type){switch(type){case"interview":super(window_manager,x,y,128,128,10,0,6);this.set_image("static/ships/teams.png",64,1,270);this.set_type("boss");this.set_max_life(500);this.set_center(64,64);let boss_action=[{type:"bank_right",frames:5},{type:"accelerate",frames:10,speed:3},{type:"bank_left",frames:10},{type:"accelerate",frames:10,speed:3},{type:"bank_left",frames:10},{type:"accelerate",frames:10,speed:3},{type:"bank_right",frames:5},{type:"skip",frames:5}];this.action_list=boss_action;this.bolt_type="bolt2";this.projectiles=[];this.laser_fire_control=new fire_control(8,2e3,1e3);break}this.rotation=180;this.is_boss=true}fire_lazer(){if(this.laser_fire_control&&this.laser_fire_control.can_fire()){let lazer1=this.get_relative_position(-40,35);var projectile1=new Projectile(this.window_manager,this.position.x+lazer1.x,this.position.y+lazer1.y,this.rotation,this.bolt_type);projectile1.set_velocity(this.velocity);projectile1.accelerate(3);this.projectiles.push(projectile1);let lazer2=this.get_relative_position(+40,35);var projectile2=new Projectile(this.window_manager,this.position.x+lazer2.x,this.position.y+lazer2.y,this.rotation,this.bolt_type);projectile2.set_velocity(this.velocity);projectile2.accelerate(3);this.projectiles.push(projectile2)}}update_frame(deltaTime){super.update_frame(deltaTime);if(this.laser_fire_control){this.laser_fire_control.update_frame();if(Math.random()<.05){this.fire_lazer()}}const timestamp=Date.now();for(let i=this.projectiles.length-1;i>=0;i--){const projectile=this.projectiles[i];if(timestamp-projectile.created>5e3){this.projectiles.splice(i,1)}else{projectile.update_frame(deltaTime)}}}render(window){super.orient(window);super.render();super.de_orient();for(let projectile of this.projectiles){projectile.orient(window);projectile.render();projectile.de_orient()}}}class Enemy extends game_object{constructor(window_manager,x,y,type){let speed=2+Math.random()*3;switch(type){case"chatgpt":super(window_manager,x,y,64,64,5,0,12);this.set_image("static/debris/email.png");this.set_type("chatgpt");this.set_max_life(80);let chatgpt_action=[{type:"bank_left",frames:2},{type:"accelerate",frames:4,speed:speed},{type:"bank_right",frames:4},{type:"accelerate",frames:4,speed:speed},{type:"skip",frames:3}];this.action_list=chatgpt_action;break;case"resume":super(window_manager,x,y,64,64,4,0,10);this.set_image("static/debris/pdf.png");this.set_type("resume");this.set_max_life(60);let resume_action=[{frames:2,type:"strafe_left",speed:speed},{frames:8,type:"accelerate",speed:speed},{frames:2,type:"strafe_right",speed:speed},{frames:8,type:"accelerate",speed:speed},{frames:5,type:"skip"}];this.action_list=resume_action;break;case"application":super(window_manager,x,y,64,64,6,0,8);this.set_image("static/debris/phone.png");this.set_type("application");this.set_max_life(100);let application_action=[{type:"accelerate",frames:6,speed:speed},{type:"bank_left",frames:3},{type:"accelerate",frames:6,speed:speed},{type:"bank_right",frames:3},{type:"skip",frames:4}];this.action_list=application_action;break}this.rotation=180}}class Powerup extends game_object{constructor(window_manager,x,y,type){super(window_manager,x,y,48,48,.5,0,5);this.powerup_type=type;switch(type){case"health":this.set_image("static/debris/pdf.png");this.set_type("powerup_health");this.heal_amount=1e3;break;case"shield":this.set_image("static/debris/email.png");this.set_type("powerup_shield");this.shield_duration=5e3;break;case"weapon":this.set_image("static/debris/phone.png");this.set_type("powerup_weapon");break}this.set_center(24,24);this.set_max_life(1);let float_action=[{type:"bank_left",frames:2},{type:"bank_right",frames:4},{type:"bank_left",frames:2},{type:"skip",frames:2}];this.action_list=float_action;this.rotation=180;this.velocity.y=20}apply_to_ship(ship){switch(this.powerup_type){case"health":ship.life+=this.heal_amount;if(ship.life>ship.max_life){ship.life=ship.max_life}console.log(`Health restored! +${this.heal_amount} HP`);break;case"shield":if(!ship.shield_active){ship.activate_shield(this.shield_duration);console.log(`Shield activated for ${this.shield_duration/1e3} seconds!`)}else{ship.shield_end_time+=this.shield_duration;console.log(`Shield extended!`)}break;case"weapon":if(ship.laser_fire_control){ship.laser_fire_control.temprature=0;ship.laser_fire_control.overheated=false}if(ship.missile_fire_control){ship.missile_fire_control.temprature=0;ship.missile_fire_control.overheated=false}console.log("Weapons cooled down!");break}this.destroy()}}class fire_control{constructor(temp_cycle=10,over_heat=2e3,overheating_timeout=2e3){this.over_heat=over_heat;this.overheating_timeout=overheating_timeout;this.last_fired_time=0;this.overheated=false;this.overheated_cooldown_start=0;this.max_rps=10;this.rps_min=1;this.rps=10;this.temprature=0;this.temp_cycle=temp_cycle;this.max_tempreture=100;this.is_firing=false}can_fire(){if(this.overheated)return;const current_time=Date.now();const elapsed_time=current_time-this.last_fired_time;if(elapsed_time>=1e3/this.rps){this.temprature+=this.temp_cycle;this.rps=this.max_rps*(1-this.temprature/this.max_tempreture);if(this.rps<this.rps_min)this.rps=this.rps_min;if(this.temprature>this.max_tempreture){this.temprature=this.max_tempreture;this.overheated=true;this.overheated_cooldown_start=0}this.last_fired_time=current_time;this.is_firing=true;return true}else{return false}}update_frame(){const current_time=Date.now();if(this.overheated){if(this.overheated_cooldown_start!=0){if(current_time-this.overheated_cooldown_start>this.overheating_timeout){this.overheated=false;this.rps=this.max_rps}else{this.temprature-=5;if(this.temprature<0)this.temprature=0}}return false}if(this.is_firing==false){this.temprature-=2;this.rps=this.max_rps*this.get_cooldown_percentage()/100;if(this.temprature<0)this.temprature=0}}get_cooldown_percentage(){return 100-this.temprature/this.max_tempreture*100}timeout_percentage(){const current_time=Date.now();if(this.overheated){if(this.overheated_cooldown_start==0)return 100;return 100-(current_time-this.overheated_cooldown_start)/this.overheating_timeout*100}return 0}stop_firing(){this.stopped_firing=Date.now();this.is_firing=false;if(this.overheated){this.overheated_cooldown_start=Date.now()}}}class level extends events{constructor(window_manager){super();this.position={x:0,y:0,width:0,height:0};this.window_manager=window_manager;this.audio_manager=window_manager.audio_manager;this.npc=[];this.explosions=[];this.projectiles=[];this.data=null;this.spaceship=null;this.track_key=null;this.speed=null;this.rows=0;this.columns=0;this.master_volume=.4}volume(level){this.master_volume+=level/10;if(this.master_volume<0){this.master_volume=0}if(this.master_volume>1){this.master_volume=1}this.audio_manager.set_master_volume(this.master_volume)}stop(){if(this.track_key&&this.audio_manager){console.log("[Level] Stopping track:",this.track_key);this.audio_manager.stop(this.track_key)}}load(level){fetch(level).then(response=>{if(!response.ok){throw new Error("Network response was not ok")}return response.json()}).then(async level_data=>{this.data=level_data;let bg=this.data["background"];let music=this.data["music"];this.background=bg;this.track_key="level_music";await this.audio_manager.add(this.track_key,music);this.speed=Number(this.data.speed);this.rows=Number(this.data.rows);this.columns=Number(this.data.columns);for(let line=0;line<this.rows;line++){var row=this.data.level[line];for(let col=0;col<this.columns+2;col++){var c=row[col];if(c==" ")continue;var block;var x=col*64;var y=line*64;switch(c){case".":block=new Derbis(this.window_manager,x,y,"block");break;case"t":block=new Ship(this.window_manager,x,y,"teams");break;case"p":block=new Derbis(this.window_manager,x,y,"pdf");break;case"e":block=new Derbis(this.window_manager,x,y,"email");break;case"c":block=new Derbis(this.window_manager,x,y,"call");break;case"w":block=new Derbis(this.window_manager,x,y,"webex");break;case"l":block=new Derbis(this.window_manager,x,y,"linkedin");break;case"z":block=new Derbis(this.window_manager,x,y,"zoom");break;case"f":block=new Derbis(this.window_manager,x,y,"facebook");break;case"r":block=new Derbis(this.window_manager,x,y,"reddit");break;case"g":block=new Enemy(this.window_manager,x,y,"chatgpt");break;case"R":block=new Enemy(this.window_manager,x,y,"resume");break;case"a":block=new Enemy(this.window_manager,x,y,"application");break;case"i":block=new Boss(this.window_manager,x,y,"interview");break;case"h":block=new Powerup(this.window_manager,x,y,"health");break;case"s":block=new Powerup(this.window_manager,x,y,"shield");break;case"W":block=new Powerup(this.window_manager,x,y,"weapon");break;case"P":this.spaceship=new Ship(this.window_manager,x,y,"user");block=this.spaceship;break}this.npc.push(block)}}const virtual_height=this.window_manager.graphics.viewport.virtual.height;this.position.y=this.rows*64-virtual_height;this.position.x=0;this.position.height=this.rows*64;this.position.width=this.columns*64;this.spaceship.set_max_life(5e3);this.emit("loaded")}).catch(error=>{console.error("There was a problem with the fetch operation:",error)})}}class ui{constructor(ctx,game_object){this.ctx=ctx;this.G=game_object}pause_game_mode(){this.G.pause_game=true}unpause_game_mode(){this.G.pause_game=false}boss_mode_on(){document.getElementById("game").style.display="none";document.getElementById("boss_mode").style.display="block";this.G.boss_mode_activated=true;this.pause_game_mode();const audio_manager=this.G.window_manager.audio_manager;if(this.G.level&&this.G.level.track_key&&audio_manager){audio_manager.pause(this.G.level.track_key)}}boss_mode_off(){document.getElementById("game").style.display="block";document.getElementById("boss_mode").style.display="none";this.G.boss_mode_activated=false;this.unpause_game_mode();const audio_manager=this.G.window_manager.audio_manager;if(this.G.level&&this.G.level.track_key&&audio_manager){audio_manager.resume(this.G.level.track_key)}}pause(){this.pause_game_mode();const audio_manager=this.G.window_manager.audio_manager;if(this.G.level&&this.G.level.track_key&&audio_manager){audio_manager.pause(this.G.level.track_key)}let pause_modal=new pause;pause_modal.on("ok",()=>{this.unpause()});this.G.window_manager.add(pause_modal)}unpause(){this.unpause_game_mode();const audio_manager=this.G.window_manager.audio_manager;if(this.G.level&&this.G.level.track_key&&audio_manager){audio_manager.resume(this.G.level.track_key)}}toggle_sound(){const audio_manager=this.G.window_manager.audio_manager;if(audio_manager.playSounds){audio_manager.sound_off();if(this.G.level.track_key){audio_manager.stop(this.G.level.track_key)}}else{audio_manager.sound_on();if(this.G.level.track_key){audio_manager.play(this.G.level.track_key,0,true)}}}updateChatWindow(){if(this.G.gameClient==null)return;const messages=this.G.gameClient.getChatMessages();this.G.chatWindow.innerHTML=messages.map(msg=>{const colorStyle=`color: rgb(${msg.color.join(",")});`;return`<div><span style="${colorStyle}"><strong>${msg.player_name}</strong>:</span><span style="color:white"> ${msg.text}</span></div>`}).join("");this.G.chatWindow.scrollTop=this.G.chatWindow.scrollHeight}updatePlayerInfo(){if(this.G.gameClient==null)return;const profile=this.G.gameClient.getPlayerProfile();this.G.player=profile;if(profile){this.G.playerNameElement.textContent=profile.name;this.G.playerAvatarElement.style.backgroundImage="url("+profile.avatar+")"}}updatePlayerStatus(){const spaceship=this.G.spaceship;document.getElementById("accelerationX").textContent=spaceship.acceleration.x.toFixed(2);document.getElementById("accelerationY").textContent=spaceship.acceleration.y.toFixed(2);document.getElementById("velocityX").textContent=spaceship.velocity.x.toFixed(2);document.getElementById("velocityY").textContent=spaceship.velocity.y.toFixed(2);document.getElementById("positionX").textContent=spaceship.position.x.toFixed(2);document.getElementById("positionY").textContent=spaceship.position.y.toFixed(2)}}class help extends modal{layout(){this.active=true;this.ok=false;this.cancel=false;this.closeButton=true;this.title="Help";let window_width=1024;let window_height=700;let x=(this.graphics.viewport.virtual.width-window_width)/2;let y=(this.graphics.viewport.virtual.height-window_height)/2;this.position=new rect(x,y,window_width,window_height,"left","top");this.text="| Key           | Action                 |\n"+"|---------------|------------------------|\n"+"| Arrow Keys    | Bank left/right        |\n"+"|               | Accelerate/decelerate  |\n"+"| WASD          | Strafe movement        |\n"+"| Space         | Fire lasers            |\n"+"| Enter         | Fire Missiles          |\n"+"| Shift         | Boost                  |\n"+"| M             | Toggle Sound           |\n"+"| +             | Volume up              |\n"+"| -             | Volume down            |\n"+"| Escape        | Toggle Pause           |\n"+"| Tab           | Boss Mode (toggle)     |\n"+"| H             | Show this help         |\n";this.resize();this.add_buttons()}}class prologue extends cinematic_player{layout(){this.ok=false;this.cancel=false;this.closeButton=true;this.title="Prologue";this.text="";this.active=true;let window_width=800;let window_height=600;let x=(this.graphics.viewport.virtual.width-window_width)/2;let y=(this.graphics.viewport.virtual.height-window_height)/2;this.position=new rect(x,y,window_width,window_height,"left","top");this.resize();this.add_buttons();this.setup_player("static/storyboard/intro/intro_scene.json")}}class high_scores extends modal{layout(){this.active=true;this.ok=false;this.cancel=false;this.closeButton=true;this.title="High Scores";this.text="";let window_width=800;let window_height=600;let x=(this.graphics.viewport.virtual.width-window_width)/2;let y=(this.graphics.viewport.virtual.height-window_height)/2;this.position=new rect(x,y,window_width,window_height,"left","top");this.resize();this.add_buttons();this.high_scores=null;this.scroll_offset=0;this.line_height=40;this.load_high_scores("static/json/highscores.json");this.render_callback(this.render_scores.bind(this));this.on("keys",data=>{this.handle_scroll_keys(data.kb)});this._bound_wheel_handler=this.handle_wheel.bind(this);this.canvas.addEventListener("wheel",this._bound_wheel_handler)}async load_high_scores(jsonFileUrl){try{const response=await fetch(jsonFileUrl);if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`)}const data=await response.json();this.high_scores=data}catch(error){console.error("Error loading the JSON file:",error)}}handle_wheel(event){if(!this.active||!this.high_scores)return;const rect=this.canvas.getBoundingClientRect();const mouseX=event.clientX-rect.left;const mouseY=event.clientY-rect.top;if(mouseX>=this.render_internal_rect.x&&mouseX<=this.render_internal_rect.x+this.render_internal_rect.width&&mouseY>=this.render_internal_rect.y&&mouseY<=this.render_internal_rect.y+this.render_internal_rect.height){event.preventDefault();this.scroll_offset+=event.deltaY*.5;const header_height=60;const scrollable_height=this.render_internal_rect.height-header_height;const max_scroll=Math.max(0,this.high_scores.length*this.line_height-scrollable_height);this.scroll_offset=Math.max(0,Math.min(this.scroll_offset,max_scroll))}}handle_scroll_keys(kb){if(!this.active||!this.high_scores)return;if(kb.is_pressed("ArrowUp")){this.scroll_offset-=5}if(kb.is_pressed("ArrowDown")){this.scroll_offset+=5}const header_height=60;const scrollable_height=this.render_internal_rect.height-header_height;if(kb.just_stopped("PageUp")){this.scroll_offset-=scrollable_height}if(kb.just_stopped("PageDown")){this.scroll_offset+=scrollable_height}if(kb.just_stopped("Home")){this.scroll_offset=0}if(kb.just_stopped("End")){const max_scroll=Math.max(0,this.high_scores.length*this.line_height-scrollable_height);this.scroll_offset=max_scroll}const max_scroll=Math.max(0,this.high_scores.length*this.line_height-scrollable_height);this.scroll_offset=Math.max(0,Math.min(this.scroll_offset,max_scroll))}render_scores(position){if(!this.high_scores){let loading_pos=new rect(position.x+position.width/2,position.y+position.height/2,null,null,"center","center");this.graphics.font.draw_text(loading_pos,"Loading...",true,false);return}const ctx=this.graphics.ctx;const header_height=60;const start_y=position.y+70-this.scroll_offset;const header_y=position.y+40;ctx.save();ctx.fillStyle="#00FFFF";ctx.font="bold 18px monospace";const rank_x=position.x+20;const name_x=position.x+100;const score_x=position.x+position.width-150;ctx.fillText("Rank",rank_x,header_y);ctx.fillText("Name",name_x,header_y);ctx.fillText("Score",score_x,header_y);ctx.strokeStyle="#00FFFF";ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(position.x+10,header_y+10);ctx.lineTo(position.x+position.width-10,header_y+10);ctx.stroke();ctx.font="16px monospace";for(let i=0;i<this.high_scores.length;i++){const score=this.high_scores[i];const y=start_y+i*this.line_height;if(y<position.y+header_height||y>position.y+position.height){continue}if(score.name==="Chris Watkins"){ctx.fillStyle="#FFFF00"}else{if(score.rank===1)ctx.fillStyle="#FFD700";else if(score.rank===2)ctx.fillStyle="#C0C0C0";else if(score.rank===3)ctx.fillStyle="#CD7F32";else ctx.fillStyle="#00FF00"}ctx.fillText(score.rank.toString(),rank_x,y);ctx.fillText(score.name,name_x,y);ctx.fillText(score.score.toLocaleString(),score_x,y)}const scrollable_height=position.height-header_height;const max_scroll=Math.max(0,this.high_scores.length*this.line_height-scrollable_height);if(max_scroll>0){const scrollbar_height=Math.max(30,scrollable_height/(this.high_scores.length*this.line_height)*scrollable_height);const scrollbar_y=position.y+header_height+this.scroll_offset/max_scroll*(scrollable_height-scrollbar_height);const scrollbar_x=position.x+position.width-15;ctx.fillStyle="rgba(0, 255, 255, 0.3)";ctx.fillRect(scrollbar_x,scrollbar_y,10,scrollbar_height)}ctx.restore()}delete(){if(this._bound_wheel_handler){this.canvas.removeEventListener("wheel",this._bound_wheel_handler)}super.delete()}}class credits extends cinematic_player{layout(){this.active=true;this.ok=false;this.cancel=false;this.closeButton=true;this.title="Credits";this.text="";let window_width=800;let window_height=800;let x=(this.graphics.viewport.virtual.width-window_width)/2;let y=(this.graphics.viewport.virtual.height-window_height)/2;this.position=new rect(x,y,window_width,window_height,"left","top");this.resize();this.add_buttons();this.setup_player("static/storyboard/credits/credits.json")}}class ui_component extends events{constructor(parent,graphics,position){super();this.parent=parent;this.graphics=graphics;this.position=position;this.anchor_position=null;this.children=[];this.visible=true;this.active=true}add_child(child){if(!this.children.includes(child)){this.children.push(child);child.parent=this}}remove_child(child){const index=this.children.indexOf(child);if(index!==-1){this.children.splice(index,1);child.parent=null}}get_absolute_position(){let absolute_position=this.position.clone();if(this.anchor_position){absolute_position.add(this.anchor_position)}return absolute_position}resize(anchor_position){this.anchor_position=anchor_position;const our_absolute=this.get_absolute_position();for(let child of this.children){if(child.resize){child.resize(our_absolute)}}}update(deltaTime){if(!this.active)return;for(let child of this.children){if(child.update){child.update(deltaTime)}}}render(){if(!this.visible||!this.active)return;this.render_self();for(let child of this.children){if(child.render){child.render()}}}render_self(){}set_visible(visible){this.visible=visible}set_active(active){this.active=active;for(let child of this.children){if(child.set_active){child.set_active(active)}}}delete(){for(let child of this.children){if(child.delete){child.delete()}}this.children=[];this.parent=null}}class percentage_bar extends ui_component{constructor(parent,graphics,position,overlay,underlay){super(parent,graphics,position);this.underlay=underlay;this.overlay=overlay;this.percentage=0}render_self(){const absolute_position=this.get_absolute_position();let percentage_width=parseInt(absolute_position.width*this.percentage/100);if(percentage_width!=0){const underlay_x=absolute_position.x+20;const underlay_y=absolute_position.y+9;let render_percentage=new rect(underlay_x,underlay_y,percentage_width*.85,absolute_position.height-18);this.graphics.sprites.render(this.underlay,null,render_percentage,1,"none")}this.graphics.sprites.slice_3(this.overlay,absolute_position)}set_percentage(percentage){this.percentage=percentage}render(percentage=null){if(percentage!==null){this.set_percentage(percentage)}super.render()}}class percentage_bar_fluid extends percentage_bar{constructor(parent,graphics,position,overlay,underlay){super(parent,graphics,position,overlay,underlay)}}class pause extends modal{layout(){this.active=true;this.ok=true;this.cancel=false;this.closeButton=true;this.title="Paused";this.text="";let window_width=800;let window_height=600;let x=(this.graphics.viewport.virtual.width-window_width)/2;let y=(this.graphics.viewport.virtual.height-window_height)/2;this.position=new rect(x,y,window_width,window_height,"left","top");this.resize();this.add_buttons()}}class cinematic_player extends modal{setup_player(scene_url){this.player=new scene(this.window_manager,scene_url);this.on("close",()=>{if(this.player)this.player.close()});this.player.on("complete",()=>{this.close()});this.render_callback(this.player.update_frame.bind(this.player));this._resume_audio_once=async()=>{if(this.audio_manager&&this.audio_manager.audioContext.state==="suspended"){await this.audio_manager.audioContext.resume();console.log("[CinematicPlayer] Audio context resumed on user interaction")}};this._resume_audio_once();this.on("keys",data=>{this.handle_cinematic_keys(data.kb)});let seekbar_position=new rect(10,this.internal_rect.height-30,this.internal_rect.width-20,20,"left","top");this.seekbar=this.create_seekbar(seekbar_position,()=>this.player?this.player.get_progress():null,time=>{if(this.player)this.player.seek_to(time,true)});this.seekbar.on("seek_end",()=>{if(this.player)this.player.end_seek()});this._bound_click_handler=this.handle_click.bind(this);this.graphics.canvas.addEventListener("click",this._bound_click_handler)}create_seekbar(position,get_progress_callback,seek_callback){let anchor_position=new rect(0,0,0,0);anchor_position.add(this.position);anchor_position.add(this.internal_rect);return new seekbar(this,this.graphics,position,anchor_position,get_progress_callback,seek_callback)}handle_click(event){if(!this.active||!this.player)return;const viewport=this.graphics.viewport;const scale=viewport.scale;const renderedWidth=viewport.virtual.width*scale.x;const renderedHeight=viewport.virtual.height*scale.y;const offsetX=(viewport.given.width-renderedWidth)/2;const offsetY=(viewport.given.height-renderedHeight)/2;const virtual_click_x=(event.offsetX-offsetX)/scale.x;const virtual_click_y=(event.offsetY-offsetY)/scale.y;if(virtual_click_x>=this.position.x&&virtual_click_x<=this.position.x+this.position.width&&virtual_click_y>=this.position.y&&virtual_click_y<=this.position.y+this.position.height){if(this.closeButton&&this.buttons){let clicking_button=false;this.buttons.forEach(button=>{if(button.is_inside(event.offsetX,event.offsetY)){clicking_button=true}});if(this.seekbar&&this.seekbar.is_inside(event.offsetX,event.offsetY)){clicking_button=true}if(!clicking_button){this.player.toggle_pause()}}else{this.player.toggle_pause()}}}handle_cinematic_keys(kb){if(!this.active||!this.player)return;if(kb.just_stopped(" ")){this.player.toggle_pause()}if(kb.just_stopped("ArrowLeft")){const new_time=Math.max(0,this.player.elapsed-5e3);this.player.seek_to(new_time,false)}if(kb.just_stopped("ArrowRight")){const new_time=this.player.elapsed+5e3;this.player.seek_to(new_time,false)}}render(){if(!this.active||!this.graphics||!this.graphics.ctx)return;super.render();if(this.seekbar){this.seekbar.render()}if(this.player&&this.graphics&&this.graphics.ctx){const ctx=this.graphics.ctx;if(!ctx||typeof ctx.save!=="function")return;const center_x=this.position.x+this.position.width/2;const center_y=this.position.y+this.position.height/2;const radius=50;ctx.save();if(this.player.paused){ctx.fillStyle="rgba(255, 255, 255, 0.5)";ctx.beginPath();ctx.arc(center_x,center_y,radius,0,Math.PI*2);ctx.fill();ctx.fillStyle="rgba(0, 0, 0, 0.8)";const bar_width=12;const bar_height=40;const bar_spacing=10;ctx.fillRect(center_x-bar_spacing-bar_width,center_y-bar_height/2,bar_width,bar_height);ctx.fillRect(center_x+bar_spacing,center_y-bar_height/2,bar_width,bar_height)}ctx.restore()}}delete(){this.active=false;if(this.seekbar){this.seekbar.delete();this.seekbar=null}if(this._bound_click_handler&&this.graphics&&this.graphics.canvas){this.graphics.canvas.removeEventListener("click",this._bound_click_handler);this._bound_click_handler=null}if(this.player){this.player.close();this.player=null}super.delete()}}class scene{constructor(window_manager,scene_url){this.graphics=window_manager.graphics;this.audio_manager=window_manager.audio_manager;this.scene_url=scene_url;this.scene_data=null;this.audio=new Audio;this.start_time=null;this.current_img=null;this.playing=null;this.paused=false;this.scene_ended=false;this.events={};this.manual_time_offset=0;this.is_dragging_seekbar=false;this.is_seeking=false;this._seek_timeout=null;this.currently_playing_audio=new Set;this.load_scene_data(this.scene_url)}on(event_name,callback){if(!this.events[event_name]){this.events[event_name]=[]}this.events[event_name].push(callback)}emit(event_name,data){if(this.events[event_name]){this.events[event_name].forEach(callback=>{callback(data)})}}async load_scene_data(scene_url){let data=await fetch(scene_url).then(response=>response.json()).then(data=>{const sceneData=data;return sceneData});this.scene_data=data;const loadPromises=[];for(let i=0;i<this.scene_data.length;i++){loadPromises.push(this.load_slide(this.scene_data[i]))}await Promise.all(loadPromises);if(this.graphics.sprites.loaded){this.play_scene()}else{this.graphics.sprites.on("complete",this.play_scene.bind(this))}}async play_scene(){if(this.audio_manager&&this.audio_manager.audioContext.state==="suspended"){await this.audio_manager.audioContext.resume()}this.playing=true;this.paused=false;this.start_time=Date.now()}get_total_duration(){let max_end_time=0;const properties=["images","audio","text"];for(let property of properties){for(let i=0;i<this.scene_data.length;i++){const slide=this.scene_data[i];if(!(property in slide))continue;for(let j=0;j<slide[property].length;j++){let object=slide[property][j];let end_time=(object.timestamp+object.duration)*1e3;if(object.duration>0&&end_time>max_end_time){max_end_time=end_time}}}}return max_end_time}get_objects_in_time(){const objectsToShow=[];const properties=["images","audio","text"];for(let property of properties){for(let i=0;i<this.scene_data.length;i++){const slide=this.scene_data[i];if(!(property in slide))continue;for(let j=0;j<slide[property].length;j++){let object=slide[property][j];let timestamp=object.timestamp*1e3;let duration=(object.timestamp+object.duration)*1e3;if(object.duration==0)duration+=9999999;if(this.elapsed>=timestamp&&this.elapsed<=duration){objectsToShow.unshift({data:object,type:property,timestamp:timestamp})}}}}return objectsToShow}seek_to(time_ms,is_dragging){this.stop_all_audio();this.currently_playing_audio.clear();this.start_time=Date.now()-time_ms;this.manual_time_offset=time_ms;this.scene_ended=false;if(is_dragging){this.is_seeking=true}else{this.is_seeking=false}}end_seek(){this.is_seeking=false}stop_all_audio(){if(this.scene_data){for(let i=0;i<this.scene_data.length;i++){const slide=this.scene_data[i];if(slide.audio){for(let j=0;j<slide.audio.length;j++){const audio=slide.audio[j];this.audio_manager.stop(audio.path)}}}}}toggle_pause(){this.paused=!this.paused;if(this.paused){this.manual_time_offset=this.elapsed;this.stop_all_audio();this.currently_playing_audio.clear()}else{this.start_time=Date.now()-this.manual_time_offset}}update_frame(position){if(!this.playing||!this.scene_data)return;if(this.start_time==null){this.start_time=Date.now()}if(this.paused){this.elapsed=this.manual_time_offset}else{this.elapsed=Date.now()-this.start_time}if(!this.scene_ended&&!this.is_seeking){let total_duration=this.get_total_duration();if(this.elapsed>=total_duration){this.scene_ended=true;this.emit("complete",{})}}let objects=this.get_objects_in_time();for(let i=0;i<objects.length;i++){let object=objects[i];if(object.type=="images"){let current_img=object.data.path;this.graphics.sprites.render(current_img,null,position,1,"fill")}}if(!this.paused&&!this.is_seeking){let should_be_playing=new Set;for(let i=0;i<objects.length;i++){let object=objects[i];if(object.type=="audio"){should_be_playing.add(object.data.path)}}for(let audio_path of this.currently_playing_audio){if(!should_be_playing.has(audio_path)){this.audio_manager.stop(audio_path);this.currently_playing_audio.delete(audio_path)}}for(let audio_path of should_be_playing){if(!this.currently_playing_audio.has(audio_path)){let matching_audio=null;let current_elapsed_seconds=this.elapsed/1e3;for(let i=0;i<this.scene_data.length;i++){const slide=this.scene_data[i];if(!slide.audio)continue;for(let j=0;j<slide.audio.length;j++){const audio=slide.audio[j];if(audio.path===audio_path){const audio_start=audio.timestamp;const audio_end=audio.timestamp+audio.duration;if(current_elapsed_seconds>=audio_start&&current_elapsed_seconds<=audio_end){matching_audio=audio;break}}}if(matching_audio)break}if(matching_audio){const offset_in_audio=current_elapsed_seconds-matching_audio.timestamp;if(offset_in_audio>=0&&offset_in_audio<=matching_audio.duration){this.currently_playing_audio.add(audio_path);this.audio_manager.play(audio_path,offset_in_audio)}}}}}for(let i=0;i<objects.length;i++){let object=objects[i];if(object.type=="text"){let text_position=new rect(position.x+position.width/2,position.y+position.height/4,null,null,"center","center");let bounds=this.graphics.font.get_bounds(object.data.text,false);var line_count=(object.data.text.match(/\n/g)||[]).length+1;bounds.width=position.width;bounds.height=this.graphics.font.mono_char_height*line_count+30;bounds.x=position.x+0;bounds.y=text_position.y-bounds.height/2;let current_position=this.elapsed-object.timestamp;let percentage=current_position/(object.data.duration*1e3);let brightness=0;if(percentage<=.5)brightness=.3+1.6*percentage;else brightness=1.7-1.6*percentage;this.graphics.sprites.draw_rect(bounds,"rgba(22, 22, 22, "+brightness+")");this.graphics.font.draw_text(text_position,object.data.text,true,false)}}}async load_slide(slide){if(slide.images){for(let i=0;i<slide.images.length;i++){this.graphics.sprites.add(slide.images[i].path)}}if(slide.audio){const audioPromises=[];for(let i=0;i<slide.audio.length;i++){audioPromises.push(this.audio_manager.add(slide.audio[i].path))}await Promise.all(audioPromises)}}play_audio(audioPath,timestamp){this.audio.src=audioPath;this.audio.currentTime=timestamp;this.audio.play()}get_progress(){return{current:this.elapsed||0,total:this.get_total_duration(),paused:this.paused}}close(){this.playing=false;if(this._seek_timeout){clearTimeout(this._seek_timeout)}this.stop_all_audio();this.currently_playing_audio.clear()}}class game extends modal{layout(){this.active=true;this.ok=false;this.cancel=false;this.closeButton=true;this.no_close=true;this.title="Level - 1";this.text="";this.level_start=false;this.lastFrameTime=Date.now();this.boss_mode_activated=false;this.pause_game=false;this.player_dying=false;this.death_started_time=0;this.death_explosion_duration=2e3;this.score=0;this.kills=0;this.ui=new ui(this.ctx,this);this.level=new level(this.window_manager);this.level.load("static/levels/level.json");this.level.on("loaded",this.start_level.bind(this));this.laser_bar=new percentage_bar_fluid(this,this.graphics,new rect(10,10+1*50,200,40),"bar","bar-red-fluid");this.missile_bar=new percentage_bar_fluid(this,this.graphics,new rect(30,10+2*50,200,40),"bar","bar-orange-fluid");this.booster_bar=new percentage_bar_fluid(this,this.graphics,new rect(30,10+3*50,200,40),"bar","bar-blue-fluid");this.shield_bar=new percentage_bar_fluid(this,this.graphics,new rect(10,10+4*50,200,40),"bar","bar-blue-fluid");this.health_bar=new percentage_bar_fluid(this,this.graphics,new rect(10,10+5*50,200,40),"bar","bar-green-fluid");this.ui_components.push(this.laser_bar,this.missile_bar,this.booster_bar,this.shield_bar,this.health_bar);this.resize();this.add_buttons();this.no_skin();this.on("keys",data=>{this.handle_game_keys(data.kb)});this.on("escape",event=>{event.defaultPrevented=true;this.handle_escape()});this.render_callback(this.updateFrame.bind(this))}resize(){let x=0;let y=0;let window_width=this.graphics.viewport.virtual.width;let window_height=this.graphics.viewport.virtual.height;this.position=new rect(x,y,window_width,window_height,"left","top");this.internal_rect=new rect(0,0,this.position.width,this.position.height,"left","top");this.render_position=this.position.clone();this.render_internal_rect=this.internal_rect.clone();this.render_internal_rect.add(this.render_position);for(let i=0;i<this.ui_components.length;i++){if(this.ui_components[i].resize){this.ui_components[i].resize(this.render_position)}}if(this.closeButton&&typeof this.closeButton.resize==="function"){this.closeButton.resize(this.render_position)}}check_collisions(){let collisions=[];let window={y1:this.level.position.y,y2:this.level.position.y+this.graphics.viewport.virtual.height};if(this.level.spaceship){for(let i=0;i<this.level.npc.length;i++){const npc=this.level.npc[i];if(npc===this.level.spaceship)continue;if(npc.position.y<window.y1||npc.position.y>window.y2)continue;if(this.level.spaceship.check_collision(npc)){collisions.push({obj1:this.level.spaceship,obj2:npc,type:"ship_npc"})}}if(this.level.spaceship.projectiles.length>0&&Math.random()<.1){console.log("[Game] Checking",this.level.spaceship.projectiles.length,"projectiles against",this.level.npc.length,"NPCs")}for(let p=0;p<this.level.spaceship.projectiles.length;p++){const projectile=this.level.spaceship.projectiles[p];for(let i=0;i<this.level.npc.length;i++){const npc=this.level.npc[i];if(npc===this.level.spaceship)continue;if(npc.position.y<window.y1||npc.position.y>window.y2)continue;if(projectile.check_collision(npc)){collisions.push({obj1:projectile,obj2:npc,type:"projectile_npc"})}}}}for(let i=0;i<this.level.npc.length;i++){const npc=this.level.npc[i];if(npc.type!=="ship"&&npc.type!=="boss")continue;if(!npc.projectiles)continue;for(let p=0;p<npc.projectiles.length;p++){const projectile=npc.projectiles[p];if(this.level.spaceship&&projectile.check_collision(this.level.spaceship)){collisions.push({obj1:projectile,obj2:this.level.spaceship,type:"enemy_projectile_ship"})}}}this.handle_collisions(collisions)}handle_collisions(collisions){for(let collision of collisions){const{obj1,obj2,type}=collision;switch(type){case"ship_npc":if(obj2.type&&obj2.type.startsWith("powerup_")){obj2.apply_to_ship(obj1)}else{obj1.impact2(obj2);const impactX=obj2.position.x-obj1.position.x;const impactY=obj2.position.y-obj1.position.y;obj1.damage(50,impactX,impactY);obj2.damage(50);obj1.explosion();obj2.explosion()}break;case"projectile_npc":if(obj2.type&&obj2.type.startsWith("powerup_")){break}console.log("[Game] Player projectile HIT:",obj2.type,"Life:",obj2.life,"→",obj2.life-25);obj1.destroy();obj2.damage(25);obj2.explosion();this.score+=10;if(obj2.life<=0){this.kills++;if(obj2.type==="boss"){this.score+=500}else if(obj2.type==="ship"){this.score+=100}else{this.score+=25}}break;case"enemy_projectile_ship":const impactX=obj1.position.x-obj2.position.x;const impactY=obj1.position.y-obj2.position.y;obj1.destroy();obj2.damage(250,impactX,impactY);obj2.explosion();break}}}updateFrame(){const currentTime=Date.now();const deltaTime=(currentTime-this.lastFrameTime)/1e3;this.lastFrameTime=currentTime;const viewport=this.graphics.viewport;this.graphics.ctx.strokeStyle="#00FF00";this.graphics.ctx.lineWidth=4;this.graphics.ctx.strokeRect(this.position.x,this.position.y,this.position.width,this.position.height);this.render_background();if(this.pause_game){let window={y1:this.level.position.y,y2:this.level.position.y+this.graphics.viewport.virtual.height};for(let b=0;b<this.level.npc.length;b++){let npc=this.level.npc[b];if(npc.position.y>window.y1-50&&npc.position.y<window.y2){if(npc.type=="ship"||npc.type=="boss"){npc.render({x:0,y:window.y1})}else{npc.orient({x:0,y:window.y1});npc.render();npc.de_orient()}}}this.render_score();if(this.level.spaceship&&this.level.spaceship.life<=0){this.draw_game_over_overlay()}return}this.level.position.y-=this.level.speed;if(this.level.position.y==0){this.level_start=false}this.graphics.viewport.world.y=this.level.position.y;let window={y1:this.level.position.y,y2:this.level.position.y+this.graphics.viewport.virtual.height};this.level.npc=this.level.npc.filter(npc=>!npc.destroy_object);for(let b=0;b<this.level.npc.length;b++){let npc=this.level.npc[b];if(npc.position.y>window.y1-50&&npc.position.y<window.y2){npc.update_motion(deltaTime)}}this.check_collisions();for(let b=0;b<this.level.npc.length;b++){let npc=this.level.npc[b];if(npc.position.y>window.y1-50&&npc.position.y<window.y2){npc.update_frame(deltaTime);if(npc.type=="ship"||npc.type=="boss"){npc.render({x:0,y:window.y1})}else{npc.orient({x:0,y:window.y1});npc.render();npc.de_orient()}}}if(this.level.spaceship!=null){if(this.level.spaceship.life<=0){if(!this.player_dying){this.player_dying=true;this.death_started_time=Date.now();console.log("[Game] Player death - starting explosion sequence")}else{const time_since_death=Date.now()-this.death_started_time;if(time_since_death>=this.death_explosion_duration){this.game_over();return}}}this.level.spaceship.update_frame(deltaTime);this.level.spaceship.render({x:0,y:window.y1})}if(this.level.spaceship!=null&&this.laser_bar&&this.missile_bar&&this.booster_bar&&this.shield_bar&&this.health_bar){this.laser_bar.set_percentage(this.level.spaceship.laser_fire_control.get_cooldown_percentage());this.missile_bar.set_percentage(this.level.spaceship.missile_fire_control.get_cooldown_percentage());this.booster_bar.set_percentage(this.level.spaceship.boost_fire_control.get_cooldown_percentage());this.shield_bar.set_percentage(this.level.spaceship.get_shield_percentage());this.health_bar.set_percentage(this.level.spaceship.get_life_percentage())}this.render_score()}render_background(){if(!this.level||!this.level.background||!this.graphics||!this.graphics.ctx)return;const ctx=this.graphics.ctx;if(!ctx||typeof ctx.save!=="function")return;const bg_sprite=this.graphics.sprites.get(this.level.background);if(!bg_sprite){console.warn("[Game] Background sprite not loaded:",this.level.background);return}const viewport=this.graphics.viewport.virtual;const bg_height=bg_sprite.height;const bg_width=bg_sprite.width;const scale=viewport.width/bg_width;const scaled_height=bg_height*scale;const total_level_height=this.level.position.height;const scroll_progress=1-this.level.position.y/total_level_height;const bg_y_offset=(scaled_height-viewport.height)*scroll_progress;const tiles_needed=Math.ceil(viewport.height/scaled_height)+1;for(let i=-1;i<tiles_needed;i++){const y_pos=i*scaled_height-bg_y_offset;ctx.drawImage(bg_sprite.image,0,y_pos,viewport.width,scaled_height)}}render_score(){if(!this.ctx||typeof this.ctx.save!=="function")return;const scoreText=`Score: ${this.score}  Kills: ${this.kills}`;const x=this.position.x+this.position.width-250;const y=this.position.y+30;this.ctx.save();this.ctx.fillStyle="#00FF00";this.ctx.font="20px monospace";this.ctx.fillText(scoreText,x,y);this.ctx.restore()}game_over(){this.pause_game=true;this.level_start=false}draw_game_over_overlay(){const ctx=this.graphics.ctx;if(!ctx||typeof ctx.save!=="function")return;const centerX=this.graphics.viewport.virtual.width/2;const centerY=this.graphics.viewport.virtual.height/2;ctx.save();ctx.fillStyle="rgba(0, 0, 0, 0.7)";ctx.fillRect(0,0,this.graphics.viewport.virtual.width,this.graphics.viewport.virtual.height);ctx.fillStyle="#FF0000";ctx.font="bold 72px monospace";ctx.textAlign="center";ctx.fillText("GAME OVER",centerX,centerY-60);ctx.fillStyle="#00FF00";ctx.font="bold 36px monospace";ctx.fillText(`Final Score: ${this.score}`,centerX,centerY+20);ctx.fillText(`Kills: ${this.kills}`,centerX,centerY+70);ctx.fillStyle="#FFFFFF";ctx.font="24px monospace";ctx.fillText("Press ESC to return to menu",centerX,centerY+130);ctx.restore()}async start_level(){this.level_start=true;if(this.level.background){this.set_background(this.level.background)}if(this.audio_manager&&this.audio_manager.audioContext.state==="suspended"){await this.audio_manager.audioContext.resume()}if(this.level.track_key){this.audio_manager.play(this.level.track_key,0,true)}}handle_game_keys(kb){if(this.active==false)return;if(this.level_start==true&&!this.pause_game){if(kb.is_pressed("ArrowLeft"))this.level.spaceship.bank_left();if(kb.is_pressed("ArrowRight"))this.level.spaceship.bank_right();if(kb.is_pressed("ArrowUp"))this.level.spaceship.accelerate(100);if(kb.is_pressed("ArrowDown"))this.level.spaceship.decelerate(100);if(kb.is_pressed(" "))this.level.spaceship.fire_lazer();if(kb.just_stopped(" "))this.level.spaceship.stop_firing_lazer();if(kb.just_stopped("Enter"))this.level.spaceship.fire_missle(this.level.npc);if(kb.is_pressed("a")||kb.is_pressed("A"))this.level.spaceship.strafe_left(100);if(kb.is_pressed("d")||kb.is_pressed("D"))this.level.spaceship.strafe_right(100);if(kb.is_pressed("w")||kb.is_pressed("W"))this.level.spaceship.accelerate(100);if(kb.is_pressed("s")||kb.is_pressed("S"))this.level.spaceship.decelerate(100);if(kb.is_pressed("Shift"))this.level.spaceship.boost();if(kb.just_stopped("Shift"))this.level.spaceship.stop_boost()}if(this.level_start==true){if(kb.just_stopped("+"))this.level.volume(+1);if(kb.just_stopped("-"))this.level.volume(-1);if(kb.just_stopped("h")||kb.just_stopped("H"))this.help();if(kb.just_stopped("m")||kb.just_stopped("M"))this.ui.toggle_sound()}}handle_escape(){if(this.level.spaceship&&this.level.spaceship.life<=0){this.close();return}if(this.pause_game==true){this.ui.unpause()}else{this.ui.pause()}}help(){let modal=new help;this.window_manager.add(modal)}delete(){if(this.level&&this.level.track_key&&this.audio_manager){console.log("[Game] Stopping music:",this.level.track_key);this.audio_manager.stop(this.level.track_key)}if(this.level){this.level.stop()}super.delete()}}function dialog(){document.getElementById("next_btn").addEventListener("click",function(){document.getElementById("intro").style.display="none";document.getElementById("game").style.display="block";initGame()});document.getElementById("underlay").style.display="flex"}document.addEventListener("DOMContentLoaded",function(){dialog()});function blipEffect(){const overlay=document.getElementById("dialog_box");const originalBrightness="brightness(100%)";const blipBrightness="brightness(80%)";let isBlipping=false;function startBlip(){if(!isBlipping){overlay.style.filter=blipBrightness;isBlipping=true;setTimeout(()=>{overlay.style.filter=originalBrightness;isBlipping=false},100)}}setInterval(()=>{if(!isBlipping){startBlip()}},Math.random()*(1e4-5e3)+2e3)}document.addEventListener("DOMContentLoaded",function(){});